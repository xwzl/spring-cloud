<div class="article-entry" itemprop="articleBody">

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>在使用 Spring Boot 时，默认就已经提供了日志功能，使用 Logback 作为默认的日志框架。本文，我们就来一起研究下，Spring Boot 是如何自动初始化好日志系统的。</p>
<p>不了解 Spring Boot 日志功能的胖友，可以先看看 <a href="http://www.iocoder.cn/Spring-Boot/battcn/v2-config-logs/?vip" rel="external nofollow noopener noreferrer" target="_blank">《一起来学 SpringBoot 2.x | 第三篇：SpringBoot 日志配置》</a> 文章。</p>
<h1 id="2-LoggingApplicationListener"><a href="#2-LoggingApplicationListener" class="headerlink" title="2. LoggingApplicationListener"></a>2. LoggingApplicationListener</h1><p>Spring Boot 提供日志功能，关键在于 LoggingApplicationListener 类。在 <a href="http://svip.iocoder.cn/Spring-Boot/ApplicationListener/">《精尽 Spring Boot 源码分析 —— ApplicationListener》</a> 中，我们已经简单介绍过它：</p>
<blockquote>
<p><validateCode>org.springframework.boot.context.logging.LoggingApplicationListener</validateCode> ，实现 GenericApplicationListener 接口，实现根据配置初始化日志系统 Logger 。</p>
</blockquote>
<h2 id="2-1-supportsEventType"><a href="#2-1-supportsEventType" class="headerlink" title="2.1 supportsEventType"></a>2.1 supportsEventType</h2><p>实现 <validateCode>#supportsEventType(ResolvableType resolvableType)</validateCode>  方法，判断是否是支持的事件类型。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] EVENT_TYPES = { ApplicationStartingEvent.class,</span><br><span class="line">		ApplicationEnvironmentPreparedEvent.class, ApplicationPreparedEvent.class,</span><br><span class="line">		ContextClosedEvent.class, ApplicationFailedEvent.class };</span><br><span class="line">		</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(ResolvableType resolvableType)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> isAssignableFrom(resolvableType.getRawClass(), EVENT_TYPES);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAssignableFrom</span><span class="params">(Class&lt;?&gt; type, Class&lt;?&gt;... supportedTypes)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (type != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; supportedType : supportedTypes) {</span><br><span class="line">			<span class="keyword">if</span> (supportedType.isAssignableFrom(type)) {</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-2-supportsSourceType"><a href="#2-2-supportsSourceType" class="headerlink" title="2.2 supportsSourceType"></a>2.2 supportsSourceType</h2><p>实现 <validateCode>#supportsSourceType(Class&lt;?&gt; sourceType)</validateCode> 方法，判断是否是支持的事件来源。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] SOURCE_TYPES = { SpringApplication.class,</span><br><span class="line">		ApplicationContext.class };</span><br><span class="line">		</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsSourceType</span><span class="params">(Class&lt;?&gt; sourceType)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> isAssignableFrom(sourceType, SOURCE_TYPES);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-3-onApplicationEvent"><a href="#2-3-onApplicationEvent" class="headerlink" title="2.3 onApplicationEvent"></a>2.3 onApplicationEvent</h2><p>实现 <validateCode>#onApplicationEvent(ApplicationEvent event)</validateCode> 方法，处理事件。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">    <span class="comment">// 在 Spring Boot 应用启动的时候</span></span><br><span class="line">	<span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationStartingEvent) {</span><br><span class="line">		onApplicationStartingEvent((ApplicationStartingEvent) event);</span><br><span class="line">    <span class="comment">// 在 Spring Boot 的 Environment 环境准备完成的时候</span></span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) {</span><br><span class="line">		onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br><span class="line">    <span class="comment">// 在 Spring Boot 容器的准备工作已经完成（并未启动）的时候</span></span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationPreparedEvent) {</span><br><span class="line">		onApplicationPreparedEvent((ApplicationPreparedEvent) event);</span><br><span class="line">    <span class="comment">// 在 Spring Boot 容器关闭的时候</span></span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ContextClosedEvent</span><br><span class="line">            &amp;&amp; ((ContextClosedEvent) event).getApplicationContext().getParent() == <span class="keyword">null</span>) {</span><br><span class="line">		onContextClosedEvent();</span><br><span class="line">	<span class="comment">// 在 Spring Boot 容器启动失败的时候</span></span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationFailedEvent) {</span><br><span class="line">		onApplicationFailedEvent();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>不同的事件，对应不同的处理方法。下文，我们一一来看。</li>
</ul>
<h2 id="2-4-onApplicationStartingEvent"><a href="#2-4-onApplicationStartingEvent" class="headerlink" title="2.4 onApplicationStartingEvent"></a>2.4 onApplicationStartingEvent</h2><p><validateCode>#onApplicationStartingEvent(ApplicationStartingEvent event)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LoggingSystem loggingSystem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationStartingEvent</span><span class="params">(ApplicationStartingEvent event)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 创建 LoggingSystem 对象</span></span><br><span class="line">	<span class="keyword">this</span>.loggingSystem = LoggingSystem.get(event.getSpringApplication().getClassLoader());</span><br><span class="line">	<span class="comment">// &lt;2&gt; LoggingSystem 的初始化的前置处理</span></span><br><span class="line">	<span class="keyword">this</span>.loggingSystem.beforeInitialize();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>LoggingSystem#get(ClassLoader classLoader)</validateCode> 方法，创建（获得） LoggingSystem 对象。关于这个，可以先看看 <a href="#">「3.1 get」</a> 小节。<ul>
<li>通过 LoggingSystem 的抽象，对应不同日志框架对应的 LoggingSystem 实现，达到方便透明的接入不同的日志框架~</li>
</ul>
</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>LoggingSystem#beforeInitialize()</validateCode> 方法，执行 LoggingSystem 的初始化的前置处理。关于这个，可以先看看 <a href="#">「3.2 beforeInitialize」</a> 小节。</li>
</ul>
<h2 id="2-5-onApplicationEnvironmentPreparedEvent"><a href="#2-5-onApplicationEnvironmentPreparedEvent" class="headerlink" title="2.5 onApplicationEnvironmentPreparedEvent"></a>2.5 onApplicationEnvironmentPreparedEvent</h2><p><validateCode>#onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent event)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationEnvironmentPreparedEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.loggingSystem == <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.loggingSystem = LoggingSystem.get(event.getSpringApplication().getClassLoader());</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 初始化</span></span><br><span class="line">	initialize(event.getEnvironment(), event.getSpringApplication().getClassLoader());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ConfigurableEnvironment environment, ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 初始化 LoggingSystemProperties 配置</span></span><br><span class="line">    <span class="keyword">new</span> LoggingSystemProperties(environment).apply();</span><br><span class="line">    <span class="comment">// &lt;2&gt; 初始化 LogFile</span></span><br><span class="line">    LogFile logFile = LogFile.get(environment);</span><br><span class="line">    <span class="keyword">if</span> (logFile != <span class="keyword">null</span>) {</span><br><span class="line">        logFile.applyToSystemProperties(); <span class="comment">// &lt;2.1&gt;</span></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;3&gt; 初始化早期的 Spring Boot Logging 级别</span></span><br><span class="line">    initializeEarlyLoggingLevel(environment);</span><br><span class="line">    <span class="comment">// &lt;4&gt; 初始化 LoggingSystem 日志系统</span></span><br><span class="line">    initializeSystem(environment, <span class="keyword">this</span>.loggingSystem, logFile);</span><br><span class="line">    <span class="comment">// &lt;5&gt; 初始化最终的 Spring Boot Logging 级别</span></span><br><span class="line">    initializeFinalLoggingLevels(environment, <span class="keyword">this</span>.loggingSystem);</span><br><span class="line">    <span class="comment">// &lt;6&gt;  </span></span><br><span class="line">    registerShutdownHookIfNecessary(environment, <span class="keyword">this</span>.loggingSystem);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>LoggingSystemProperties#apply()</validateCode> 方法，初始化 LoggingSystemProperties 配置。关于这个，可以先看看 <a href="#">「4. LoggingSystemProperties」</a> 小节。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>LogFile#get(environment)</validateCode> 方法，创建（获得）LogFile 。关于这个，可以先看看 <a href="#">「5. LogFile」</a> 小节。<ul>
<li><validateCode>&lt;2.1&gt;</validateCode> 处，调用 <validateCode>LogFile#applyToSystemProperties()</validateCode> 方法，应用 <validateCode>LogFile.path</validateCode> 和 <validateCode>LogFile.file</validateCode> 到系统属性中。</li>
</ul>
</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#initializeEarlyLoggingLevel(ConfigurableEnvironment environment)</validateCode> 方法，初始化早期的 Spring Boot Logging 级别。详细解析，见 <a href="#">「2.5.1 initializeEarlyLoggingLevel」</a> 中。</li>
<li><validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>#initializeSystem(ConfigurableEnvironment environment, LoggingSystem system, LogFile logFile)</validateCode> 方法，初始化 LoggingSystem 日志系统。详细解析，见 <a href="#">「2.5.2 initializeSystem」</a> 中。</li>
<li><validateCode>&lt;5&gt;</validateCode> 处，调用 <validateCode>#initializeFinalLoggingLevels(ConfigurableEnvironment environment, LoggingSystem system)</validateCode> 方法，初始化最终的 Spring Boot Logging 级别。详细解析，见 <a href="#">「2.5.3 initializeFinalLoggingLevels」</a> 中。</li>
<li><validateCode>&lt;6&gt;</validateCode> 处，调用 <validateCode>#registerShutdownHookIfNecessary(Environment environment, LoggingSystem loggingSystem)</validateCode> 方法，注册 ShutdownHook 。详细解析，见 <a href="#">「2.5.4」</a> 中。</li>
</ul>
<h3 id="2-5-1-initializeEarlyLoggingLevel"><a href="#2-5-1-initializeEarlyLoggingLevel" class="headerlink" title="2.5.1 initializeEarlyLoggingLevel"></a>2.5.1 initializeEarlyLoggingLevel</h3><p><validateCode>#initializeEarlyLoggingLevel(ConfigurableEnvironment environment)</validateCode> 方法，初始化早期的 Spring Boot Logging 级别。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> parseArgs = <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> LogLevel springBootLogging = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeEarlyLoggingLevel</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.parseArgs &amp;&amp; <span class="keyword">this</span>.springBootLogging == <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">if</span> (isSet(environment, <span class="string">"debug"</span>)) {</span><br><span class="line">			<span class="keyword">this</span>.springBootLogging = LogLevel.DEBUG;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (isSet(environment, <span class="string">"trace"</span>)) {</span><br><span class="line">			<span class="keyword">this</span>.springBootLogging = LogLevel.TRACE;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSet</span><span class="params">(ConfigurableEnvironment environment, String property)</span> </span>{</span><br><span class="line">	String value = environment.getProperty(property);</span><br><span class="line">	<span class="keyword">return</span> (value != <span class="keyword">null</span> &amp;&amp; !value.equals(<span class="string">"false"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>可以通过在启动 jar 的时候，跟上 <validateCode>--debug</validateCode> 或 <validateCode>--trace</validateCode> 。</li>
<li>也可以在配置文件中，添加 <validateCode>debug=true</validateCode> 或 <validateCode>trace=true</validateCode> 。</li>
<li>关于日志级别，可以先看看 <a href="#">「6. LogLevel」</a> 。</li>
</ul>
<h3 id="2-5-2-initializeSystem"><a href="#2-5-2-initializeSystem" class="headerlink" title="2.5.2 initializeSystem"></a>2.5.2 initializeSystem</h3><p><validateCode>#initializeSystem(ConfigurableEnvironment environment, LoggingSystem system, LogFile logFile)</validateCode> 方法，初始化 LoggingSystem 日志系统。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_PROPERTY = <span class="string">"logging.config"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeSystem</span><span class="params">(ConfigurableEnvironment environment, LoggingSystem system, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 创建 LoggingInitializationContext 对象</span></span><br><span class="line">    LoggingInitializationContext initializationContext = <span class="keyword">new</span> LoggingInitializationContext(environment);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 获得日志组件的配置文件</span></span><br><span class="line">    String logConfig = environment.getProperty(CONFIG_PROPERTY);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果没配置，则直接初始化 LoggingSystem</span></span><br><span class="line">    <span class="keyword">if</span> (ignoreLogConfig(logConfig)) {</span><br><span class="line">        system.initialize(initializationContext, <span class="keyword">null</span>, logFile);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果有配置，先尝试加载指定配置文件，然后在初始化 LoggingSystem</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ResourceUtils.getURL(logConfig).openStream().close();</span><br><span class="line">            system.initialize(initializationContext, logConfig, logFile); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> We can't use the logger here to report the problem</span></span><br><span class="line">            System.err.println(<span class="string">"Logging system failed to initialize "</span> + <span class="string">"using configuration from '"</span> + logConfig + <span class="string">"'"</span>);</span><br><span class="line">            ex.printStackTrace(System.err);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，创建 LoggingInitializationContext 对象。其中，<validateCode>org.springframework.boot.logging.LoggingInitializationContext</validateCode> ，LoggingSystem 初始化时的 Context 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingInitializationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingInitializationContext</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoggingInitializationContext</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">		<span class="keyword">this</span>.environment = environment;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Environment <span class="title">getEnvironment</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.environment;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>虽然目前只有 <validateCode>environment</validateCode> 属性。但是未来可以在后面增加新的参数，而无需改动 <validateCode>LoggingSystem#initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法。</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，从 <validateCode>environment</validateCode> 中获得 <validateCode>"logging.config"</validateCode> ，即获得日志组件的配置文件。一般情况下，我们无需配置。因为根据不同的日志系统，Spring Boot 按如下“约定规则”组织配置文件名加载日志配置文件：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>日志框架</th>
<th>配置文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logback</td>
<td>logback-spring.xml, logback-spring.groovy, logback.xml, logback.groovy</td>
</tr>
<tr>
<td>Log4j</td>
<td>log4j-spring.properties, log4j-spring.xml, log4j.properties, log4j.xml</td>
</tr>
<tr>
<td>Log4j2</td>
<td>log4j2-spring.xml, log4j2.xml</td>
</tr>
<tr>
<td>JDK (Java Util Logging)</td>
<td>logging.properties</td>
</tr>
</tbody>
</table>
<ul>
<li><validateCode>&lt;3&gt;</validateCode> 和 <validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>LoggingSystem#initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法，初始化 LoggingSystem 日志系统。详细解析，可以先看看 <a href="#">「3.3 initialize」</a> 。</li>
<li><validateCode>&lt;3&gt;</validateCode> 和 <validateCode>&lt;4&gt;</validateCode> 处，差异点在于后者多了 <validateCode>ResourceUtils.getURL(logConfig).openStream().close()</validateCode> 代码块，看着有点奇怪哟？它的作用是，尝试去加载 <validateCode>logConfig</validateCode> 对应的配置文件，看看是否真的存在~</li>
</ul>
<h3 id="2-5-3-initializeFinalLoggingLevels"><a href="#2-5-3-initializeFinalLoggingLevels" class="headerlink" title="2.5.3 initializeFinalLoggingLevels"></a>2.5.3 initializeFinalLoggingLevels</h3><p><validateCode>#initializeFinalLoggingLevels(ConfigurableEnvironment environment, LoggingSystem system)</validateCode> 方法，初始化最终的 Spring Boot Logging 级别。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeFinalLoggingLevels</span><span class="params">(ConfigurableEnvironment environment, LoggingSystem system)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 如果 springBootLogging 非空，则设置到日志级别</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.springBootLogging != <span class="keyword">null</span>) {</span><br><span class="line">        initializeLogLevel(system, <span class="keyword">this</span>.springBootLogging);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; 设置 environment 中配置的日志级别</span></span><br><span class="line">    setLogLevels(system, environment);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，如果 <validateCode>springBootLogging</validateCode> 非空，则调用 <validateCode>#initializeLogLevel(LoggingSystem system, LogLevel level)</validateCode> 方法，设置日志级别。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;LogLevel, List&lt;String&gt;&gt; LOG_LEVEL_LOGGERS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">	MultiValueMap&lt;LogLevel, String&gt; loggers = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">	loggers.add(LogLevel.DEBUG, <span class="string">"sql"</span>);</span><br><span class="line">	loggers.add(LogLevel.DEBUG, <span class="string">"web"</span>);</span><br><span class="line">	loggers.add(LogLevel.DEBUG, <span class="string">"org.springframework.boot"</span>);</span><br><span class="line">	loggers.add(LogLevel.TRACE, <span class="string">"org.springframework"</span>);</span><br><span class="line">	loggers.add(LogLevel.TRACE, <span class="string">"org.apache.tomcat"</span>);</span><br><span class="line">	loggers.add(LogLevel.TRACE, <span class="string">"org.apache.catalina"</span>);</span><br><span class="line">	loggers.add(LogLevel.TRACE, <span class="string">"org.eclipse.jetty"</span>);</span><br><span class="line">	loggers.add(LogLevel.TRACE, <span class="string">"org.hibernate.tool.hbm2ddl"</span>);</span><br><span class="line">	LOG_LEVEL_LOGGERS = Collections.unmodifiableMap(loggers);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeLogLevel</span><span class="params">(LoggingSystem system, LogLevel level)</span> </span>{</span><br><span class="line">	List&lt;String&gt; loggers = LOG_LEVEL_LOGGERS.get(level);</span><br><span class="line">	<span class="keyword">if</span> (loggers != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">for</span> (String logger : loggers) {</span><br><span class="line">			system.setLogLevel(logger, level);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>遍历的 <validateCode>loggers</validateCode> ，是 <validateCode>LOG_LEVEL_LOGGERS</validateCode> 中对应的 <validateCode>level</validateCode> 的值。</li>
<li>调用 <validateCode>LoggingSystem#setLogLevel(String loggerName, LogLevel level)</validateCode> 方法，设置指定 <validateCode>loggerName</validateCode> 的日志级别。详细解析，见 <a href="#">「3.4 setLogLevel」</a> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#setLogLevels(LoggingSystem system, Environment environment)</validateCode> 方法，设置 environment 中配置的日志级别。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigurationPropertyName LOGGING_LEVEL = ConfigurationPropertyName.of(<span class="string">"logging.level"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigurationPropertyName LOGGING_GROUP = ConfigurationPropertyName.of(<span class="string">"logging.group"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Bindable&lt;Map&lt;String, String&gt;&gt; STRING_STRING_MAP = Bindable.mapOf(String.class, String.class);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Bindable&lt;Map&lt;String, String[]&gt;&gt; STRING_STRINGS_MAP = Bindable.mapOf(String.class, String[].class);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setLogLevels</span><span class="params">(LoggingSystem system, Environment environment)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!(environment <span class="keyword">instanceof</span> ConfigurableEnvironment)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 创建 Binder 对象</span></span><br><span class="line">    Binder binder = Binder.get(environment);</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得日志分组的集合</span></span><br><span class="line">    Map&lt;String, String[]&gt; groups = getGroups(); <span class="comment">// &lt;1.1&gt;</span></span><br><span class="line">    binder.bind(LOGGING_GROUP, STRING_STRINGS_MAP.withExistingValue(groups)); <span class="comment">// &lt;1.2&gt;</span></span><br><span class="line">    <span class="comment">// &lt;2&gt; 获得日志级别的集合</span></span><br><span class="line">    Map&lt;String, String&gt; levels = binder.bind(LOGGING_LEVEL, STRING_STRING_MAP).orElseGet(Collections::emptyMap);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 遍历 levels 集合，逐个设置日志级别</span></span><br><span class="line">    levels.forEach((name, level) -&gt; {</span><br><span class="line">        String[] groupedNames = groups.get(name);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(groupedNames)) {</span><br><span class="line">            setLogLevel(system, name, level);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            setLogLevel(system, groupedNames, level);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，获得日志分组的集合。</p>
<ul>
<li><p><validateCode>&lt;1.1&gt;</validateCode> 处，调用 <validateCode>#getGroups()</validateCode> 方法，获得默认的日志分组集合。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; DEFAULT_GROUP_LOGGERS;</span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">	MultiValueMap&lt;String, String&gt; loggers = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">	loggers.add(<span class="string">"web"</span>, <span class="string">"org.springframework.core.codec"</span>);</span><br><span class="line">	loggers.add(<span class="string">"web"</span>, <span class="string">"org.springframework.http"</span>);</span><br><span class="line">	loggers.add(<span class="string">"web"</span>, <span class="string">"org.springframework.web"</span>);</span><br><span class="line">	loggers.add(<span class="string">"web"</span>, <span class="string">"org.springframework.boot.actuate.endpoint.web"</span>);</span><br><span class="line">	loggers.add(<span class="string">"web"</span>, <span class="string">"org.springframework.boot.web.servlet.ServletContextInitializerBeans"</span>);</span><br><span class="line">	loggers.add(<span class="string">"sql"</span>, <span class="string">"org.springframework.jdbc.core"</span>);</span><br><span class="line">	loggers.add(<span class="string">"sql"</span>, <span class="string">"org.hibernate.SQL"</span>);</span><br><span class="line">	DEFAULT_GROUP_LOGGERS = Collections.unmodifiableMap(loggers);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String[]&gt; getGroups() {</span><br><span class="line">	Map&lt;String, String[]&gt; groups = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">	DEFAULT_GROUP_LOGGERS.forEach(</span><br><span class="line">			(name, loggers) -&gt; groups.put(name, StringUtils.toStringArray(loggers)));</span><br><span class="line">	<span class="keyword">return</span> groups;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>实际上，就是把我们日常配置的 <validateCode>loggerName</validateCode> 进行了分组。默认情况下，内置了 <validateCode>sql</validateCode>、<validateCode>web</validateCode> 分组。</li>
</ul>
</li>
<li><validateCode>&lt;1.2&gt;</validateCode> 处，从 <validateCode>environment</validateCode> 中读取 <validateCode>logging.group</validateCode> 配置的日志分组。举个例子，在配置文件里增加 <validateCode>logging.group.demo=xxx.Dog,yyy.Cat</validateCode> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，从 <validateCode>environment</validateCode> 中读取 <validateCode>logging.level</validateCode> 配置的日志分组。举两个例子，在配置文件里添加：</p>
<ul>
<li><validateCode>logging.level.web=INFO</validateCode></li>
<li><validateCode>logging.level.xxx.Dog=INFO</validateCode></li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，遍历 <validateCode>levels</validateCode> 集合，逐个设置日志级别。涉及的方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setLogLevel</span><span class="params">(LoggingSystem system, String[] names, String level)</span> </span>{</span><br><span class="line">    <span class="comment">// 遍历 names 数组</span></span><br><span class="line">    <span class="keyword">for</span> (String name : names) {</span><br><span class="line">        setLogLevel(system, name, level);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setLogLevel</span><span class="params">(LoggingSystem system, String name, String level)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 获得 loggerName</span></span><br><span class="line">        name = name.equalsIgnoreCase(LoggingSystem.ROOT_LOGGER_NAME) ? <span class="keyword">null</span> : name;</span><br><span class="line">        <span class="comment">// 设置日志级别</span></span><br><span class="line">        system.setLogLevel(name, coerceLogLevel(level));</span><br><span class="line">    } <span class="keyword">catch</span> (RuntimeException ex) {</span><br><span class="line">        <span class="keyword">this</span>.logger.error(<span class="string">"Cannot set level '"</span> + level + <span class="string">"' for '"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> level 日志级别字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 将字符串转换成 {<span class="doctag">@link</span> LogLevel}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> LogLevel <span class="title">coerceLogLevel</span><span class="params">(String level)</span> </span>{</span><br><span class="line">    String trimmedLevel = level.trim();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"false"</span>.equalsIgnoreCase(trimmedLevel)) { <span class="comment">// false =&gt; OFF</span></span><br><span class="line">        <span class="keyword">return</span> LogLevel.OFF;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> LogLevel.valueOf(trimmedLevel.toUpperCase(Locale.ENGLISH));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>比较简单，胖友瞅瞅~</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-5-4-registerShutdownHookIfNecessary"><a href="#2-5-4-registerShutdownHookIfNecessary" class="headerlink" title="2.5.4 registerShutdownHookIfNecessary"></a>2.5.4 registerShutdownHookIfNecessary</h3><p><validateCode>#registerShutdownHookIfNecessary(Environment environment, LoggingSystem loggingSystem)</validateCode> 方法，注册 ShutdownHook 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the Spring property that controls the registration of a shutdown hook</span></span><br><span class="line"><span class="comment"> * to shut down the logging system when the JVM exits.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> LoggingSystem#getShutdownHandler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTER_SHUTDOWN_HOOK_PROPERTY = <span class="string">"logging.register-shutdown-hook"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerShutdownHookIfNecessary</span><span class="params">(Environment environment, LoggingSystem loggingSystem)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得 logging.register-shutdown-hook 对应的配置值</span></span><br><span class="line">    <span class="keyword">boolean</span> registerShutdownHook = environment.getProperty(REGISTER_SHUTDOWN_HOOK_PROPERTY, Boolean.class, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 如果开启</span></span><br><span class="line">    <span class="keyword">if</span> (registerShutdownHook) {</span><br><span class="line">        <span class="comment">// &lt;x&gt; 获得 shutdownHandler 钩子</span></span><br><span class="line">        Runnable shutdownHandler = loggingSystem.getShutdownHandler();</span><br><span class="line">        <span class="comment">// 注册 ShutdownHook(</span></span><br><span class="line">        <span class="keyword">if</span> (shutdownHandler != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; shutdownHookRegistered.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line">            registerShutdownHook(<span class="keyword">new</span> Thread(shutdownHandler));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">(Thread shutdownHook)</span> </span>{</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，所注册的 ShutdownHook ，通过调用 <validateCode>LoggingSystem#getShutdownHandler()</validateCode> 方法，进行获得。详细解析，见 <a href="#">「3.5 getShutdownHandler」</a>。</li>
</ul>
<h2 id="2-6-onApplicationPreparedEvent"><a href="#2-6-onApplicationPreparedEvent" class="headerlink" title="2.6 onApplicationPreparedEvent"></a>2.6 onApplicationPreparedEvent</h2><p><validateCode>#onApplicationPreparedEvent(ApplicationPreparedEvent event)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of the {<span class="doctag">@link</span> LoggingSystem} bean.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGGING_SYSTEM_BEAN_NAME = <span class="string">"springBootLoggingSystem"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationPreparedEvent</span><span class="params">(ApplicationPreparedEvent event)</span> </span>{</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = event.getApplicationContext().getBeanFactory();</span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.containsBean(LOGGING_SYSTEM_BEAN_NAME)) {</span><br><span class="line">		beanFactory.registerSingleton(LOGGING_SYSTEM_BEAN_NAME, <span class="keyword">this</span>.loggingSystem);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>将创建的 LoggingSystem 对象，注册到 Spring 容器中。</li>
</ul>
<h2 id="2-7-onContextClosedEvent"><a href="#2-7-onContextClosedEvent" class="headerlink" title="2.7  onContextClosedEvent"></a>2.7  onContextClosedEvent</h2><p><validateCode>#onContextClosedEvent()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onContextClosedEvent</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.loggingSystem != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.loggingSystem.cleanUp();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>调用 <validateCode>LoggingSystem#cleanUp()</validateCode> 方法，执行清理。详细解析，见 <a href="#">「3.6 cleanUp」</a> 中。</li>
</ul>
<h2 id="2-8-onApplicationFailedEvent"><a href="#2-8-onApplicationFailedEvent" class="headerlink" title="2.8 onApplicationFailedEvent"></a>2.8 onApplicationFailedEvent</h2><p><validateCode>#onApplicationFailedEvent()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationFailedEvent</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.loggingSystem != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.loggingSystem.cleanUp();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>至此，我们需要来看看 LoggingSystem 的实现类。具体的，可以跳到 <a href="#">「7. LoggingSystem 的实现类」</a> 中。</p>
</blockquote>
<h1 id="3-LoggingSystem"><a href="#3-LoggingSystem" class="headerlink" title="3. LoggingSystem"></a>3. LoggingSystem</h1><p><validateCode>org.springframework.boot.logging.LoggingSystem</validateCode> ，日志系统抽象类。每个日志框架，都会对应一个实现类。如下图所示：<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01-new/01.jpg" alt="LoggingSystem 实现类"></p>
<h2 id="3-1-get"><a href="#3-1-get" class="headerlink" title="3.1 get"></a>3.1 get</h2><p><validateCode>#get(ClassLoader classLoader)</validateCode> 方法，创建（获得） LoggingSystem 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingApplicationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A System property that can be used to indicate the {<span class="doctag">@link</span> LoggingSystem} to use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_PROPERTY = LoggingSystem.class.getName();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The value of the {<span class="doctag">@link</span> #SYSTEM_PROPERTY} that can be used to indicate that no</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> LoggingSystem} should be used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NONE = <span class="string">"none"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; SYSTEMS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">	Map&lt;String, String&gt; systems = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">	systems.put(<span class="string">"ch.qos.logback.core.Appender"</span>, <span class="string">"org.springframework.boot.logging.logback.LogbackLoggingSystem"</span>);</span><br><span class="line">	systems.put(<span class="string">"org.apache.logging.log4j.core.impl.Log4jContextFactory"</span>, <span class="string">"org.springframework.boot.logging.log4j2.Log4J2LoggingSystem"</span>);</span><br><span class="line">	systems.put(<span class="string">"java.util.logging.LogManager"</span>, <span class="string">"org.springframework.boot.logging.java.JavaLoggingSystem"</span>);</span><br><span class="line">	SYSTEMS = Collections.unmodifiableMap(systems);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoggingSystem <span class="title">get</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 从系统参数 org.springframework.boot.logging.LoggingSystem 获得 loggingSystem 类型</span></span><br><span class="line">    String loggingSystem = System.getProperty(SYSTEM_PROPERTY);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 如果非空，说明配置了</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(loggingSystem)) {</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 如果是 none ，则创建 NoOpLoggingSystem 对象</span></span><br><span class="line">        <span class="keyword">if</span> (NONE.equals(loggingSystem)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NoOpLoggingSystem();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// &lt;2.2&gt; 获得 loggingSystem 对应的 LoggingSystem 类，进行创建对象</span></span><br><span class="line">        <span class="keyword">return</span> get(classLoader, loggingSystem);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果为空，说明未配置，则顺序查找 SYSTEMS 中的类。如果存在指定类，则创建该类。</span></span><br><span class="line">    <span class="keyword">return</span> SYSTEMS.entrySet().stream()</span><br><span class="line">            .filter((entry) -&gt; ClassUtils.isPresent(entry.getKey(), classLoader))</span><br><span class="line">            .map((entry) -&gt; get(classLoader, entry.getValue())).findFirst()</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> IllegalStateException(<span class="string">"No suitable logging system located"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，从系统参数 <validateCode>org.springframework.boot.logging.LoggingSystem</validateCode> 获得 loggingSystem 类型。</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，如果非空，说明配置了。</p>
<ul>
<li><validateCode>&lt;2.1&gt;</validateCode> 处，如果是 <validateCode>none</validateCode> ，则创建 NoOpLoggingSystem 对象。</li>
<li><p><validateCode>&lt;2.2&gt;</validateCode> 处，调用 <validateCode>#get(ClassLoader classLoader, String loggingSystemClass)</validateCode> 方法，获得 <validateCode>loggingSystem</validateCode> 对应的 LoggingSystem 类，进行创建对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LoggingSystem <span class="title">get</span><span class="params">(ClassLoader classLoader, String loggingSystemClass)</span> </span>{</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		Class&lt;?&gt; systemClass = ClassUtils.forName(loggingSystemClass, classLoader);</span><br><span class="line">		<span class="keyword">return</span> (LoggingSystem) systemClass.getConstructor(ClassLoader.class).newInstance(classLoader);</span><br><span class="line">	} <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>systemClass</validateCode> 中的 VALUES ，就是 <validateCode>loggingSystem</validateCode> 对应的类。</li>
</ul>
</li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，如果为空，说明未配置，则顺序查找 <validateCode>SYSTEMS</validateCode> 中的类。如果存在指定类，则创建该类。</p>
</li>
</ul>
<h2 id="3-2-beforeInitialize"><a href="#3-2-beforeInitialize" class="headerlink" title="3.2 beforeInitialize"></a>3.2 beforeInitialize</h2><p><validateCode>#beforeInitialize()</validateCode> <strong>抽象</strong>方法，初始化的前置方法。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reset the logging system to be limit output. This method may be called before</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #initialize(LoggingInitializationContext, String, LogFile)} to reduce</span></span><br><span class="line"><span class="comment"> * logging noise until the system has been fully initialized.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">beforeInitialize</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-initialize"><a href="#3-3-initialize" class="headerlink" title="3.3 initialize"></a>3.3 initialize</h2><p><validateCode>#initialize()</validateCode> 方法，初始化。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fully initialize the logging system.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initializationContext the logging initialization context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> configLocation a log configuration location or {<span class="doctag">@validateCode</span> null} if default</span></span><br><span class="line"><span class="comment"> * initialization is required</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> logFile the log output file that should be written or {<span class="doctag">@validateCode</span> null} for</span></span><br><span class="line"><span class="comment"> * console only output</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>目前是个空方法，需要子类来实现。</li>
<li>我们先不着急看子类的实现，等后面继续看。</li>
</ul>
<h2 id="3-4-setLogLevel"><a href="#3-4-setLogLevel" class="headerlink" title="3.4 setLogLevel"></a>3.4 setLogLevel</h2><p><validateCode>#setLogLevel(String loggerName, LogLevel level)</validateCode> 方法，设置指定 <validateCode>loggerName</validateCode> 的日志级别。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the logging level for a given logger.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loggerName the name of the logger to set ({<span class="doctag">@validateCode</span> null} can be used for the</span></span><br><span class="line"><span class="comment"> * root logger).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> level the log level ({<span class="doctag">@validateCode</span> null} can be used to remove any custom level for</span></span><br><span class="line"><span class="comment"> * the logger and use the default configuration instead)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogLevel</span><span class="params">(String loggerName, LogLevel level)</span> </span>{</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Unable to set log level"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>目前是个空方法，需要子类来实现。</li>
<li>我们先不着急看子类的实现，等后面继续看。</li>
</ul>
<h2 id="3-5-getShutdownHandler"><a href="#3-5-getShutdownHandler" class="headerlink" title="3.5 getShutdownHandler"></a>3.5 getShutdownHandler</h2><p><validateCode>#getShutdownHandler()</validateCode> 方法，获得 ShutdownHook 的 Runnable 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a {<span class="doctag">@link</span> Runnable} that can handle shutdown of this logging system when the</span></span><br><span class="line"><span class="comment"> * JVM exits. The default implementation returns {<span class="doctag">@validateCode</span> null}, indicating that no</span></span><br><span class="line"><span class="comment"> * shutdown is required.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the shutdown handler, or {<span class="doctag">@validateCode</span> null}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Runnable <span class="title">getShutdownHandler</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>目前是个空方法，需要子类来实现。</li>
<li>我们先不着急看子类的实现，等后面继续看。</li>
</ul>
<h2 id="3-6-cleanUp"><a href="#3-6-cleanUp" class="headerlink" title="3.6 cleanUp"></a>3.6 cleanUp</h2><p><validateCode>#cleanUp()</validateCode> 方法，清理。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Clean up the logging system. The default implementation does nothing. Subclasses</span></span><br><span class="line"><span class="comment"> * should override this method to perform any logging system-specific cleanup.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanUp</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>目前是个空方法，需要子类来实现。</li>
<li>我们先不着急看子类的实现，等后面继续看。</li>
</ul>
<h1 id="4-LoggingSystemProperties"><a href="#4-LoggingSystemProperties" class="headerlink" title="4. LoggingSystemProperties"></a>4. LoggingSystemProperties</h1><p><validateCode>org.springframework.boot.logging.LoggingSystemProperties</validateCode> ，LoggingSystem 的配置类。</p>
<h2 id="4-1-构造方法"><a href="#4-1-构造方法" class="headerlink" title="4.1 构造方法"></a>4.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystemProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LoggingSystemProperties</span><span class="params">(Environment environment)</span> </span>{</span><br><span class="line">	Assert.notNull(environment, <span class="string">"Environment must not be null"</span>);</span><br><span class="line">	<span class="keyword">this</span>.environment = environment;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-2-apply"><a href="#4-2-apply" class="headerlink" title="4.2 apply"></a>4.2 apply</h2><p><validateCode>#apply()</validateCode> 方法，解析 <validateCode>environment</validateCode> 的配置变量到系统属性中。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystemProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span> </span>{</span><br><span class="line">    apply(<span class="keyword">null</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得 PropertyResolver 对象</span></span><br><span class="line">    PropertyResolver resolver = getPropertyResolver();</span><br><span class="line">    <span class="comment">// &lt;2&gt; 解析配置文件到系统属性中</span></span><br><span class="line">    setSystemProperty(resolver, EXCEPTION_CONVERSION_WORD, <span class="string">"exception-conversion-word"</span>);</span><br><span class="line">    setSystemProperty(PID_KEY, <span class="keyword">new</span> ApplicationPid().toString()); <span class="comment">// 应用进程编号</span></span><br><span class="line">    setSystemProperty(resolver, CONSOLE_LOG_PATTERN, <span class="string">"pattern.console"</span>);</span><br><span class="line">    setSystemProperty(resolver, FILE_LOG_PATTERN, <span class="string">"pattern.file"</span>);</span><br><span class="line">    setSystemProperty(resolver, FILE_MAX_HISTORY, <span class="string">"file.max-history"</span>);</span><br><span class="line">    setSystemProperty(resolver, FILE_MAX_SIZE, <span class="string">"file.max-size"</span>);</span><br><span class="line">    setSystemProperty(resolver, LOG_LEVEL_PATTERN, <span class="string">"pattern.level"</span>);</span><br><span class="line">    setSystemProperty(resolver, LOG_DATEFORMAT_PATTERN, <span class="string">"pattern.dateformat"</span>);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果 logFile 非空，则应用配置</span></span><br><span class="line">    <span class="keyword">if</span> (logFile != <span class="keyword">null</span>) {</span><br><span class="line">        logFile.applyToSystemProperties();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getPropertyResolver()</validateCode> 方法，获得 PropertyResolver 对象。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystemProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PropertyResolver <span class="title">getPropertyResolver</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) {</span><br><span class="line">		PropertySourcesPropertyResolver resolver = <span class="keyword">new</span> PropertySourcesPropertyResolver(((ConfigurableEnvironment) <span class="keyword">this</span>.environment).getPropertySources());</span><br><span class="line">		resolver.setIgnoreUnresolvableNestedPlaceholders(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">return</span> resolver;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.environment;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#setSystemProperty(PropertyResolver resolver, String systemPropertyName, String propertyName)</validateCode> 方法，解析配置文件到系统属性中。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystemProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PID_KEY = <span class="string">"PID"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCEPTION_CONVERSION_WORD = <span class="string">"LOG_EXCEPTION_CONVERSION_WORD"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_FILE = <span class="string">"LOG_FILE"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_PATH = <span class="string">"LOG_PATH"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_LOG_PATTERN = <span class="string">"FILE_LOG_PATTERN"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_MAX_HISTORY = <span class="string">"LOG_FILE_MAX_HISTORY"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_MAX_SIZE = <span class="string">"LOG_FILE_MAX_SIZE"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_LEVEL_PATTERN = <span class="string">"LOG_LEVEL_PATTERN"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_DATEFORMAT_PATTERN = <span class="string">"LOG_DATEFORMAT_PATTERN"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSystemProperty</span><span class="params">(PropertyResolver resolver, String systemPropertyName, String propertyName)</span> </span>{</span><br><span class="line">	setSystemProperty(systemPropertyName, resolver.getProperty(<span class="string">"logging."</span> + propertyName)); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSystemProperty</span><span class="params">(String name, String value)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (System.getProperty(name) == <span class="keyword">null</span> &amp;&amp; value != <span class="keyword">null</span>) {</span><br><span class="line">		System.setProperty(name, value);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，读取的是 <validateCode>environment</validateCode> 中的 <validateCode>logging.</validateCode> 开头的配置属性。</li>
</ul>
</li>
</ul>
<h1 id="5-LogFile"><a href="#5-LogFile" class="headerlink" title="5. LogFile"></a>5. LogFile</h1><p><validateCode>org.springframework.boot.logging.LogFile</validateCode> ，日志文件。</p>
<h2 id="5-1-构造方法"><a href="#5-1-构造方法" class="headerlink" title="5.1 构造方法"></a>5.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String file;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-2-applyToSystemProperties"><a href="#5-2-applyToSystemProperties" class="headerlink" title="5.2 applyToSystemProperties"></a>5.2 applyToSystemProperties</h2><p><validateCode>#applyToSystemProperties()</validateCode> 方法，应用 <validateCode>file</validateCode>、<validateCode>path</validateCode> 到系统属性。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_NAME_PROPERTY = <span class="string">"logging.file.name"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_PATH_PROPERTY = <span class="string">"logging.file.path"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyToSystemProperties</span><span class="params">()</span> </span>{</span><br><span class="line">	applyTo(System.getProperties());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applyTo</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">	put(properties, LoggingSystemProperties.LOG_PATH, <span class="keyword">this</span>.path);</span><br><span class="line">	put(properties, LoggingSystemProperties.LOG_FILE, toString());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>#toString()</validateCode> 方法，返回文件名。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.file)) {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.file;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> File(<span class="keyword">this</span>.path, <span class="string">"spring.log"</span>).getPath();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><validateCode>#put(Properties properties, String key, String value)</validateCode> 方法，添加属性值到系统属性。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Properties properties, String key, String value)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasLength(value)) {</span><br><span class="line">		properties.put(key, value);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="5-3-get"><a href="#5-3-get" class="headerlink" title="5.3 get"></a>5.3 get</h2><p><validateCode>#get(PropertyResolver propertyResolver)</validateCode> 方法，获得（创建）LogFile 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LogFile <span class="title">get</span><span class="params">(PropertyResolver propertyResolver)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得 file 和 path 属性</span></span><br><span class="line">	String file = getLogFileProperty(propertyResolver, FILE_NAME_PROPERTY, FILE_PROPERTY);</span><br><span class="line">	String path = getLogFileProperty(propertyResolver, FILE_PATH_PROPERTY, PATH_PROPERTY);</span><br><span class="line">	<span class="comment">// &lt;2&gt; 创建 LogFile 对象</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasLength(file) || StringUtils.hasLength(path)) {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LogFile(file, path);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getLogFileProperty(PropertyResolver propertyResolver, String propertyName, String deprecatedPropertyName)</validateCode> 方法，获得 <validateCode>file</validateCode> 和 <validateCode>path</validateCode> 属性。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogFile.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getLogFileProperty</span><span class="params">(PropertyResolver propertyResolver, String propertyName, String deprecatedPropertyName)</span> </span>{</span><br><span class="line">	String property = propertyResolver.getProperty(propertyName);</span><br><span class="line">	<span class="keyword">if</span> (property != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">return</span> property;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> propertyResolver.getProperty(deprecatedPropertyName);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><validateCode>&lt;2&gt;</validateCode> 处，创建 LogFile 对象。</li>
</ul>
<h1 id="6-LogLevel"><a href="#6-LogLevel" class="headerlink" title="6. LogLevel"></a>6. LogLevel</h1><p><validateCode>org.springframework.boot.logging.LogLevel</validateCode> ，Spring Boot 日志枚举类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogLevel.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LogLevel {</span><br><span class="line"></span><br><span class="line">	TRACE, DEBUG, INFO, WARN, ERROR, FATAL, OFF</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>每个日志框架，都有其日志级别。通过 LogLevel 枚举类，和它们映射。</p>
<h1 id="7-LoggingSystem-的实现类"><a href="#7-LoggingSystem-的实现类" class="headerlink" title="7. LoggingSystem 的实现类"></a>7. LoggingSystem 的实现类</h1><h2 id="7-1-NoOpLoggingSystem"><a href="#7-1-NoOpLoggingSystem" class="headerlink" title="7.1 NoOpLoggingSystem"></a>7.1 NoOpLoggingSystem</h2><p>NoOpLoggingSystem ，是 LoggingSystem 的内部静态类，继承 LoggingSystem 类，空操作的 LoggingSystem 实现类，用于禁用日志系统的时候。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LoggingSystem#NoOpLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NoOpLoggingSystem</span> <span class="keyword">extends</span> <span class="title">LoggingSystem</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeInitialize</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogLevel</span><span class="params">(String loggerName, LogLevel level)</span> </span>{</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;LoggerConfiguration&gt; <span class="title">getLoggerConfigurations</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> LoggerConfiguration <span class="title">getLoggerConfiguration</span><span class="params">(String loggerName)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-2-AbstractLoggingSystem"><a href="#7-2-AbstractLoggingSystem" class="headerlink" title="7.2 AbstractLoggingSystem"></a>7.2 AbstractLoggingSystem</h2><p><validateCode>org.springframework.boot.logging.AbstractLoggingSystem</validateCode> ，继承 LoggingSystem 抽象类，是 LoggingSystem 的抽象基类。</p>
<h3 id="7-2-1-构造方法"><a href="#7-2-1-构造方法" class="headerlink" title="7.2.1 构造方法"></a>7.2.1 构造方法</h3><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractLoggingSystem</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br><span class="line">	<span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-2-2-initialize"><a href="#7-2-2-initialize" class="headerlink" title="7.2.2 initialize"></a>7.2.2 initialize</h3><p>实现 <validateCode>#initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法，提供模板化的初始化逻辑。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 有自定义的配置文件，则使用指定配置文件进行初始化</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(configLocation)) {</span><br><span class="line">        initializeWithSpecificConfig(initializationContext, configLocation, logFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; 无自定义的配置文件，则使用约定配置文件进行初始化</span></span><br><span class="line">    initializeWithConventions(initializationContext, logFile);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，有自定义的配置文件，则调用 <validateCode>#initializeWithSpecificConfig(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法，使用指定配置文件进行初始化。详细解析，见 <a href="#">「7.2.2.1 initializeWithSpecificConfig」</a> 。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，无自定义的配置文件，则调用 <validateCode>#initializeWithConventions(LoggingInitializationContext initializationContext, LogFile logFile)</validateCode> 方法，使用约定配置文件进行初始化。详细解析，见 <a href="#">7.2.2.2 initializeWithConventions</a> 。</li>
</ul>
<h4 id="7-2-2-1-initializeWithSpecificConfig"><a href="#7-2-2-1-initializeWithSpecificConfig" class="headerlink" title="7.2.2.1 initializeWithSpecificConfig"></a>7.2.2.1 initializeWithSpecificConfig</h4><p><validateCode>#initializeWithSpecificConfig(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法，使用指定配置文件进行初始化。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeWithSpecificConfig</span><span class="params">(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得配置文件（可能有占位符）</span></span><br><span class="line">    configLocation = SystemPropertyUtils.resolvePlaceholders(configLocation);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 加载配置文件</span></span><br><span class="line">    loadConfiguration(initializationContext, configLocation, logFile);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，获得配置文件（可能有占位符）。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#loadConfiguration(LoggingInitializationContext initializationContext, String location, LogFile logFile))</validateCode> <strong>抽象</strong>方法，加载配置文件。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load a specific configuration.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initializationContext the logging initialization context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> location the location of the configuration to load (never {<span class="doctag">@validateCode</span> null})</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> logFile the file to load or {<span class="doctag">@validateCode</span> null} if no log file is to be written</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadConfiguration</span><span class="params">(LoggingInitializationContext initializationContext, String location, LogFile logFile)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="7-2-2-2-initializeWithConventions"><a href="#7-2-2-2-initializeWithConventions" class="headerlink" title="7.2.2.2 initializeWithConventions"></a>7.2.2.2 initializeWithConventions</h4><p><validateCode>#initializeWithConventions(LoggingInitializationContext initializationContext, LogFile logFile)</validateCode> 方法，使用约定配置文件进行初始化。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeWithConventions</span><span class="params">(LoggingInitializationContext initializationContext, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得约定配置文件</span></span><br><span class="line">    String config = getSelfInitializationConfig();</span><br><span class="line">    <span class="comment">// &lt;2&gt; 如果获取到，结果 logFile 为空，则重新初始化</span></span><br><span class="line">    <span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; logFile == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// self initialization has occurred, reinitialize in case of property changes</span></span><br><span class="line">        reinitialize(initializationContext);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果获取不到，则尝试获得约定配置文件（带 spring 后缀）</span></span><br><span class="line">    <span class="keyword">if</span> (config == <span class="keyword">null</span>) {</span><br><span class="line">        config = getSpringInitializationConfig();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;4&gt; 如果获取到，则加载配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (config != <span class="keyword">null</span>) {</span><br><span class="line">        loadConfiguration(initializationContext, config, logFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;5&gt; 如果获取不到，则加载默认配置</span></span><br><span class="line">    loadDefaults(initializationContext, logFile);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getSelfInitializationConfig()</validateCode> 方法，获得约定配置文件。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getSelfInitializationConfig</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> findConfig(getStandardConfigLocations());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> String[] getStandardConfigLocations();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">findConfig</span><span class="params">(String[] locations)</span> </span>{</span><br><span class="line">    <span class="comment">// 遍历 locations 数组，逐个判断是否存在。若存在，则返回</span></span><br><span class="line">    <span class="keyword">for</span> (String location : locations) {</span><br><span class="line">        ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(location, <span class="keyword">this</span>.classLoader);</span><br><span class="line">        <span class="keyword">if</span> (resource.exists()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"classpath:"</span> + location;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>#getStandardConfigLocations()</validateCode> <strong>抽象</strong>方法，获得约定的配置文件。例如说：LogbackLoggingSystem 返回的是 <validateCode>"logback-test.groovy"</validateCode>、<validateCode>"logback-test.xml"</validateCode>、 <validateCode>"logback.groovy"</validateCode>、<validateCode>"logback.xml"</validateCode> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，如果获取到，结果 <validateCode>logFile</validateCode> 为空，则调用 <validateCode>#reinitialize(LoggingInitializationContext initializationContext)</validateCode> 方法，重新初始化。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reinitialize the logging system if required. Called when</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #getSelfInitializationConfig()} is used and the log file hasn't changed. May</span></span><br><span class="line"><span class="comment"> * be used to reload configuration (for example to pick up additional System</span></span><br><span class="line"><span class="comment"> * properties).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initializationContext the logging initialization context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reinitialize</span><span class="params">(LoggingInitializationContext initializationContext)</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>一般情况下，<validateCode>logFile</validateCode> 非空~</li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，如果获取不到，则调用 <validateCode>#getSpringInitializationConfig()</validateCode> 方法，尝试获得约定配置文件（带 <validateCode>-spring</validateCode> 后缀）。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return any spring specific initialization config that should be applied. By default</span></span><br><span class="line"><span class="comment"> * this method checks {<span class="doctag">@link</span> #getSpringConfigLocations()}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the spring initialization config or {<span class="doctag">@validateCode</span> null}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getSpringInitializationConfig</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> findConfig(getSpringConfigLocations());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the spring config locations for this system. By default this method returns</span></span><br><span class="line"><span class="comment"> * a set of locations based on {<span class="doctag">@link</span> #getStandardConfigLocations()}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the spring config locations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getSpringInitializationConfig()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> String[] getSpringConfigLocations() {</span><br><span class="line">	String[] locations = getStandardConfigLocations();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; locations.length; i++) {</span><br><span class="line">		String extension = StringUtils.getFilenameExtension(locations[i]);</span><br><span class="line">		<span class="comment">// 在文件名和后缀之间，拼接一个</span></span><br><span class="line">		locations[i] = locations[i].substring(<span class="number">0</span>, locations[i].length() - extension.length() - <span class="number">1</span>)</span><br><span class="line">                + <span class="string">"-spring."</span> + extension;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> locations;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>例如说：LogbackLoggingSystem 返回的是 <validateCode>"logback-test-spring.groovy"</validateCode>、<validateCode>"logback-test-spring.xml"</validateCode>、 <validateCode>"logback-spring.groovy"</validateCode>、<validateCode>"logback-spring.xml"</validateCode> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;4&gt;</validateCode> 处，如果获取到，则调用 <validateCode>#loadConfiguration(LoggingInitializationContext initializationContext, String location, LogFile logFile))</validateCode> <strong>抽象</strong>方法，加载配置文件。</p>
</li>
<li><validateCode>&lt;5&gt;</validateCode> 处，如果获取不到，则调用 <validateCode>#loadDefaults(LoggingInitializationContext initializationContext, LogFile logFile)</validateCode> <strong>抽象</strong>方法，加载默认配置。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load sensible defaults for the logging system.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initializationContext the logging initialization context</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> logFile the file to load or {<span class="doctag">@validateCode</span> null} if no log file is to be written</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadDefaults</span><span class="params">(LoggingInitializationContext initializationContext, LogFile logFile)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="7-2-3-LogLevels"><a href="#7-2-3-LogLevels" class="headerlink" title="7.2.3 LogLevels"></a>7.2.3 LogLevels</h3><p>LogLevels ，是 AbstractLoggingSystem 的内部静态类，用于 Spring Boot LogLevel 和日志框架的 LogLevel 做映射。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// AbstractLoggingSystem#LogLevels.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maintains a mapping between native levels and {<span class="doctag">@link</span> LogLevel}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the native level type</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LogLevels</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;LogLevel, T&gt; systemToNative;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;T, LogLevel&gt; nativeToSystem;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LogLevels</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">this</span>.systemToNative = <span class="keyword">new</span> EnumMap&lt;&gt;(LogLevel.class);</span><br><span class="line">		<span class="keyword">this</span>.nativeToSystem = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LogLevel system, T nativeLevel)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.systemToNative.containsKey(system)) {</span><br><span class="line">			<span class="keyword">this</span>.systemToNative.put(system, nativeLevel);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.nativeToSystem.containsKey(nativeLevel)) {</span><br><span class="line">			<span class="keyword">this</span>.nativeToSystem.put(nativeLevel, system);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> LogLevel <span class="title">convertNativeToSystem</span><span class="params">(T level)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.nativeToSystem.get(level);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">convertSystemToNative</span><span class="params">(LogLevel level)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.systemToNative.get(level);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Set&lt;LogLevel&gt; <span class="title">getSupported</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.nativeToSystem.values());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-3-Slf4JLoggingSystem"><a href="#7-3-Slf4JLoggingSystem" class="headerlink" title="7.3 Slf4JLoggingSystem"></a>7.3 Slf4JLoggingSystem</h2><p><validateCode>org.springframework.boot.logging.Slf4JLoggingSystem</validateCode> ，继承 AbstractLoggingSystem 抽象类，基于 Slf4J 的 LoggingSystem 的抽象基类。</p>
<h3 id="7-3-1-beforeInitialize"><a href="#7-3-1-beforeInitialize" class="headerlink" title="7.3.1 beforeInitialize"></a>7.3.1 beforeInitialize</h3><p>重写 <validateCode>#beforeInitialize()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeInitialize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 父方法</span></span><br><span class="line">    <span class="keyword">super</span>.beforeInitialize();</span><br><span class="line">    <span class="comment">// &lt;1&gt; 配置 JUL 的桥接处理器</span></span><br><span class="line">    configureJdkLoggingBridgeHandler();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>因为艿艿没有特别完整的了解过日志框架，所以下面的解释，更多凭的是“直觉”！如果有错误的地方，给艿艿星球留言哈~</li>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#configureJdkLoggingBridgeHandler()</validateCode> 方法，配置 JUL 的桥接处理器。详细解析，见 <a href="#">「7.3.1.1 configureJdkLoggingBridgeHandler」</a> 。</li>
</ul>
<h4 id="7-3-1-1-configureJdkLoggingBridgeHandler"><a href="#7-3-1-1-configureJdkLoggingBridgeHandler" class="headerlink" title="7.3.1.1 configureJdkLoggingBridgeHandler"></a>7.3.1.1 configureJdkLoggingBridgeHandler</h4><p><validateCode>#configureJdkLoggingBridgeHandler()</validateCode> 方法，配置 JUL 的桥接处理器。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureJdkLoggingBridgeHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;1&gt; 判断 JUL 是否桥接到 SLF4J 了</span></span><br><span class="line">        <span class="keyword">if</span> (isBridgeJulIntoSlf4j()) {</span><br><span class="line">            <span class="comment">// &lt;2&gt; 移除 JUL 桥接处理器</span></span><br><span class="line">            removeJdkLoggingBridgeHandler();</span><br><span class="line">            <span class="comment">// &lt;3&gt; 重新安装 SLF4JBridgeHandler</span></span><br><span class="line">            SLF4JBridgeHandler.install();</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="comment">// Ignore. No java.util.logging bridge is installed.</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#isBridgeJulIntoSlf4j()</validateCode> 方法，判断 JUL 是否桥接到 SLF4J 了。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BRIDGE_HANDLER = <span class="string">"org.slf4j.bridge.SLF4JBridgeHandler"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return whether bridging JUL into SLF4J or not.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> whether bridging JUL into SLF4J or not</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isBridgeJulIntoSlf4j</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> isBridgeHandlerAvailable() <span class="comment">// 判断是否存在 SLF4JBridgeHandler 类</span></span><br><span class="line">            &amp;&amp; isJulUsingASingleConsoleHandlerAtMost(); <span class="comment">// 判断是否 JUL 只有 ConsoleHandler 处理器被创建了</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isBridgeHandlerAvailable</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> ClassUtils.isPresent(BRIDGE_HANDLER, getClassLoader());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isJulUsingASingleConsoleHandlerAtMost</span><span class="params">()</span> </span>{</span><br><span class="line">	Logger rootLogger = LogManager.getLogManager().getLogger(<span class="string">""</span>);</span><br><span class="line">	Handler[] handlers = rootLogger.getHandlers();</span><br><span class="line">	<span class="keyword">return</span> handlers.length == <span class="number">0</span></span><br><span class="line">			|| (handlers.length == <span class="number">1</span> &amp;&amp; handlers[<span class="number">0</span>] <span class="keyword">instanceof</span> ConsoleHandler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>第一个方法，调用后面的两个方法判断~</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#removeJdkLoggingBridgeHandler()</validateCode> 方法，移除 JUL 桥接处理器。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeJdkLoggingBridgeHandler</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		<span class="comment">// 移除 JUL 的 ConsoleHandler</span></span><br><span class="line">		removeDefaultRootHandler();</span><br><span class="line">		<span class="comment">// 卸载 SLF4JBridgeHandler</span></span><br><span class="line">		SLF4JBridgeHandler.uninstall();</span><br><span class="line">	} <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">		<span class="comment">// Ignore and continue</span></span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeDefaultRootHandler</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		Logger rootLogger = LogManager.getLogManager().getLogger(<span class="string">""</span>);</span><br><span class="line">		Handler[] handlers = rootLogger.getHandlers();</span><br><span class="line">		<span class="keyword">if</span> (handlers.length == <span class="number">1</span> &amp;&amp; handlers[<span class="number">0</span>] <span class="keyword">instanceof</span> ConsoleHandler) {</span><br><span class="line">			rootLogger.removeHandler(handlers[<span class="number">0</span>]);</span><br><span class="line">		}</span><br><span class="line">	} <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">		<span class="comment">// Ignore and continue</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>移除 JUL 的 ConsoleHandler ，卸载 SLF4JBridgeHandler 。</li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，会重新安装 SLF4JBridgeHandler。</p>
</li>
</ul>
<h3 id="7-3-2-cleanUp"><a href="#7-3-2-cleanUp" class="headerlink" title="7.3.2 cleanUp"></a>7.3.2 cleanUp</h3><p>重写 <validateCode>#cleanUp()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanUp</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 判断 JUL 是否桥接到 SLF4J 了</span></span><br><span class="line">    <span class="keyword">if</span> (isBridgeHandlerAvailable()) {</span><br><span class="line">        <span class="comment">// 移除 JUL 桥接处理器</span></span><br><span class="line">        removeJdkLoggingBridgeHandler();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-3-3-loadConfiguration"><a href="#7-3-3-loadConfiguration" class="headerlink" title="7.3.3 loadConfiguration"></a>7.3.3 loadConfiguration</h3><p>重写 <validateCode>#loadConfiguration(LoggingInitializationContext initializationContext, String location, LogFile logFile)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// Slf4JLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadConfiguration</span><span class="params">(LoggingInitializationContext initializationContext, String location, LogFile logFile)</span> </span>{</span><br><span class="line">	Assert.notNull(location, <span class="string">"Location must not be null"</span>);</span><br><span class="line">	<span class="keyword">if</span> (initializationContext != <span class="keyword">null</span>) {</span><br><span class="line">		applySystemProperties(initializationContext.getEnvironment(), logFile);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>调用 <validateCode>#applySystemProperties(Environment environment, LogFile logFile)</validateCode> 方法，应用 <validateCode>environment</validateCode> 和 <validateCode>logFile</validateCode> 的属性，到系统属性种。在 <a href="#">「4.2 apply」</a> 中，已经详细解析。</li>
<li>不过有一点，搞不懂，为什么这么实现。</li>
</ul>
<h2 id="7-4-LogbackLoggingSystem"><a href="#7-4-LogbackLoggingSystem" class="headerlink" title="7.4 LogbackLoggingSystem"></a>7.4 LogbackLoggingSystem</h2><p><validateCode>org.springframework.boot.logging.logback.LogbackLoggingSystem</validateCode> ，继承 Slf4JLoggingSystem 抽象类，基于 Logback 的 LoggingSystem 实现类。</p>
<h3 id="7-4-1-beforeInitialize"><a href="#7-4-1-beforeInitialize" class="headerlink" title="7.4.1 beforeInitialize"></a>7.4.1 beforeInitialize</h3><p>重写 <validateCode>#beforeInitialize()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeInitialize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1.1&gt; 获得 LoggerContext 对象</span></span><br><span class="line">    LoggerContext loggerContext = getLoggerContext();</span><br><span class="line">    <span class="comment">// &lt;1.2&gt; 如果已经初始化过，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (isAlreadyInitialized(loggerContext)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; 调用父方法</span></span><br><span class="line">    <span class="keyword">super</span>.beforeInitialize();</span><br><span class="line">    <span class="comment">// &lt;3&gt; 添加 FILTER 到其中</span></span><br><span class="line">    loggerContext.getTurboFilterList().add(FILTER);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1.1&gt;</validateCode> 处，调用 <validateCode>#getLoggerContext()</validateCode> 方法，获得 LoggerContext 对象。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> LoggerContext <span class="title">getLoggerContext</span><span class="params">()</span> </span>{</span><br><span class="line">	ILoggerFactory factory = StaticLoggerBinder.getSingleton().getLoggerFactory();</span><br><span class="line">	Assert.isInstanceOf(LoggerContext.class, factory,</span><br><span class="line">			String.format(</span><br><span class="line">					<span class="string">"LoggerFactory is not a Logback LoggerContext but Logback is on "</span></span><br><span class="line">							+ <span class="string">"the classpath. Either remove Logback or the competing "</span></span><br><span class="line">							+ <span class="string">"implementation (%s loaded from %s). If you are using "</span></span><br><span class="line">							+ <span class="string">"WebLogic you will need to add 'org.slf4j' to "</span></span><br><span class="line">							+ <span class="string">"prefer-application-packages in WEB-INF/weblogic.xml"</span>,</span><br><span class="line">					factory.getClass(), getLocation(factory)));</span><br><span class="line">	<span class="keyword">return</span> (LoggerContext) factory;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><validateCode>&lt;1.2&gt;</validateCode> 处，调用 <validateCode>#isAlreadyInitialized(LoggerContext loggerContext)</validateCode> 方法，判断如果已经初始化过，则直接返回。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAlreadyInitialized</span><span class="params">(LoggerContext loggerContext)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> loggerContext.getObject(LoggingSystem.class.getName()) != <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用父方法。</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，添加 <validateCode>FILTER</validateCode> 到 <validateCode>loggerContext</validateCode> 其中。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TurboFilter FILTER = <span class="keyword">new</span> TurboFilter() {</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, ch.qos.logback.classic.Logger logger,</span></span></span><br><span class="line"><span class="function"><span class="params">			Level level, String format, Object[] params, Throwable t)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> FilterReply.DENY;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>因为此时，Logback 并未初始化好，所以全部返回 <validateCode>FilterReply.DENY</validateCode> 。即，先不打印日志。</li>
</ul>
</li>
</ul>
<h3 id="7-4-2-getStandardConfigLocations"><a href="#7-4-2-getStandardConfigLocations" class="headerlink" title="7.4.2 getStandardConfigLocations"></a>7.4.2 getStandardConfigLocations</h3><p>实现 <validateCode>#getStandardConfigLocations()</validateCode> 方法，获得约定的配置文件的数组。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> String[] getStandardConfigLocations() {</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> String[] { <span class="string">"logback-test.groovy"</span>, <span class="string">"logback-test.xml"</span>, <span class="string">"logback.groovy"</span>,</span><br><span class="line">			<span class="string">"logback.xml"</span> };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-4-3-initialize"><a href="#7-4-3-initialize" class="headerlink" title="7.4.3 initialize"></a>7.4.3 initialize</h3><p>重写 <validateCode>#initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIGURATION_FILE_PROPERTY = <span class="string">"logback.configurationFile"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 如果已经初始化，则返回</span></span><br><span class="line">    LoggerContext loggerContext = getLoggerContext();</span><br><span class="line">    <span class="keyword">if</span> (isAlreadyInitialized(loggerContext)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; 调用父方法</span></span><br><span class="line">    <span class="keyword">super</span>.initialize(initializationContext, configLocation, logFile);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 移除 FILTER</span></span><br><span class="line">    loggerContext.getTurboFilterList().remove(FILTER);</span><br><span class="line">    <span class="comment">// &lt;4&gt; 标记已经初始化</span></span><br><span class="line">    markAsInitialized(loggerContext);</span><br><span class="line">    <span class="comment">// &lt;5&gt; 如果配置了 logback.configurationFile ，则打印日志</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(System.getProperty(CONFIGURATION_FILE_PROPERTY))) {</span><br><span class="line">        getLogger(LogbackLoggingSystem.class.getName()).warn(<span class="string">"Ignoring '"</span> + CONFIGURATION_FILE_PROPERTY + <span class="string">"' system property. "</span> + <span class="string">"Please use 'logging.config' instead."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，如果已经初始化，则返回。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用父方法，进行初始化。</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，从 <validateCode>loggerContext</validateCode> 中，移除 <validateCode>FILTER</validateCode> 。😈 如果不移除，就一直打印不出日志列。</li>
<li><p><validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>#markAsInitialized(LoggerContext loggerContext)</validateCode> 方法，标记已经初始化。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markAsInitialized</span><span class="params">(LoggerContext loggerContext)</span> </span>{</span><br><span class="line">	loggerContext.putObject(LoggingSystem.class.getName(), <span class="keyword">new</span> Object());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><validateCode>&lt;5&gt;</validateCode> 处，如果配置了 <validateCode>"logback.configurationFile"</validateCode> ，则打印日志。</p>
</li>
</ul>
<h4 id="7-4-3-1-loadConfiguration"><a href="#7-4-3-1-loadConfiguration" class="headerlink" title="7.4.3.1 loadConfiguration"></a>7.4.3.1 loadConfiguration</h4><p>实现 <validateCode>#loadConfiguration(LoggingInitializationContext initializationContext, String location, LogFile logFile)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadConfiguration</span><span class="params">(LoggingInitializationContext initializationContext, String location, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 调用父方法</span></span><br><span class="line">    <span class="keyword">super</span>.loadConfiguration(initializationContext, location, logFile);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 重置</span></span><br><span class="line">    LoggerContext loggerContext = getLoggerContext();</span><br><span class="line">    stopAndReset(loggerContext);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 读取配置文件，并进行配置</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        configureByResourceUrl(initializationContext, loggerContext, ResourceUtils.getURL(location));</span><br><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not initialize Logback logging from "</span> + location, ex);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;4&gt; 判断是否发生错误。如果有，则抛出 IllegalStateException 异常</span></span><br><span class="line">    List&lt;Status&gt; statuses = loggerContext.getStatusManager().getCopyOfStatusList();</span><br><span class="line">    StringBuilder errors = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (Status status : statuses) {</span><br><span class="line">        <span class="keyword">if</span> (status.getLevel() == Status.ERROR) {</span><br><span class="line">            errors.append((errors.length() &gt; <span class="number">0</span>) ? String.format(<span class="string">"%n"</span>) : <span class="string">""</span>);</span><br><span class="line">            errors.append(status.toString());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (errors.length() &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Logback configuration error detected: %n%s"</span>, errors));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用父方法。</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#stopAndReset(LoggerContext loggerContext)</validateCode> 方法，重置。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopAndReset</span><span class="params">(LoggerContext loggerContext)</span> </span>{</span><br><span class="line">    <span class="comment">// 停止</span></span><br><span class="line">    loggerContext.stop();</span><br><span class="line">    <span class="comment">// 重置</span></span><br><span class="line">    loggerContext.reset();</span><br><span class="line">    <span class="comment">// 如果是 SLF4J 桥接</span></span><br><span class="line">    <span class="keyword">if</span> (isBridgeHandlerInstalled()) {</span><br><span class="line">        <span class="comment">// 添加 LevelChangePropagator</span></span><br><span class="line">        addLevelChangePropagator(loggerContext);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBridgeHandlerInstalled</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!isBridgeHandlerAvailable()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    java.util.logging.Logger rootLogger = LogManager.getLogManager().getLogger(<span class="string">""</span>);</span><br><span class="line">    Handler[] handlers = rootLogger.getHandlers();</span><br><span class="line">    <span class="comment">// 判断有 SLF4JBridgeHandler 唯一元素</span></span><br><span class="line">    <span class="keyword">return</span> handlers.length == <span class="number">1</span> &amp;&amp; handlers[<span class="number">0</span>] <span class="keyword">instanceof</span> SLF4JBridgeHandler;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLevelChangePropagator</span><span class="params">(LoggerContext loggerContext)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建 LevelChangePropagator 对象（见 https://cloud.tencent.com/developer/ask/174323 说明）</span></span><br><span class="line">    LevelChangePropagator levelChangePropagator = <span class="keyword">new</span> LevelChangePropagator();</span><br><span class="line">    <span class="comment">// 设置属性</span></span><br><span class="line">    levelChangePropagator.setResetJUL(<span class="keyword">true</span>);</span><br><span class="line">    levelChangePropagator.setContext(loggerContext);</span><br><span class="line">    <span class="comment">// 添加 LevelChangePropagator 到 loggerContext 中</span></span><br><span class="line">    loggerContext.addListener(levelChangePropagator);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过阅读 <a href="https://cloud.tencent.com/developer/ask/174323" rel="external nofollow noopener noreferrer" target="_blank">https://cloud.tencent.com/developer/ask/174323</a> 文章，我们能弄懂这里为什么要使用 LevelChangePropagator ，以及 <a href="#">「7.3.1.1 configureJdkLoggingBridgeHandler」</a> 处的原因。</li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#configureByResourceUrl(LoggingInitializationContext initializationContext, LoggerContext loggerContext, URL url)</validateCode> 方法，读取配置文件，并进行配置。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureByResourceUrl</span><span class="params">(LoggingInitializationContext initializationContext, LoggerContext loggerContext, URL url)</span> <span class="keyword">throws</span> JoranException </span>{</span><br><span class="line">    <span class="comment">// &lt;X&gt; 如果是 xml 配置格式，则使用 SpringBootJoranConfigurator</span></span><br><span class="line">    <span class="keyword">if</span> (url.toString().endsWith(<span class="string">"xml"</span>)) {</span><br><span class="line">        JoranConfigurator configurator = <span class="keyword">new</span> SpringBootJoranConfigurator(initializationContext);</span><br><span class="line">        configurator.setContext(loggerContext);</span><br><span class="line">        configurator.doConfigure(url);</span><br><span class="line">    <span class="comment">// 如果是其它格式，则使用 ContextInitializer</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">new</span> ContextInitializer(loggerContext).configureByResource(url);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，如果是 Logback xml 配置格式，则使用 SpringBootJoranConfigurator 类。</li>
<li>至此，Logback 配置文件，就已经被读完落。</li>
</ul>
</li>
<li><p><validateCode>&lt;4&gt;</validateCode> 处，判断是否发生错误。如果有，则抛出 IllegalStateException 异常。</p>
</li>
</ul>
<h5 id="7-4-3-1-1-SpringBootJoranConfigurator"><a href="#7-4-3-1-1-SpringBootJoranConfigurator" class="headerlink" title="7.4.3.1.1 SpringBootJoranConfigurator"></a>7.4.3.1.1 SpringBootJoranConfigurator</h5><p><validateCode>org.springframework.boot.logging.logback.SpringBootJoranConfigurator</validateCode> ，继承 JoranConfigurator 类，增加 Spring Boot 自定义的标签。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// SpringBootJoranConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringBootJoranConfigurator</span> <span class="keyword">extends</span> <span class="title">JoranConfigurator</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> LoggingInitializationContext initializationContext;</span><br><span class="line"></span><br><span class="line">	SpringBootJoranConfigurator(LoggingInitializationContext initializationContext) {</span><br><span class="line">		<span class="keyword">this</span>.initializationContext = initializationContext;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInstanceRules</span><span class="params">(RuleStore rs)</span> </span>{</span><br><span class="line">	    <span class="comment">// 调用父方法</span></span><br><span class="line">		<span class="keyword">super</span>.addInstanceRules(rs);</span><br><span class="line">		Environment environment = <span class="keyword">this</span>.initializationContext.getEnvironment();</span><br><span class="line">		rs.addRule(<span class="keyword">new</span> ElementSelector(<span class="string">"configuration/springProperty"</span>), <span class="keyword">new</span> SpringPropertyAction(environment));</span><br><span class="line">		rs.addRule(<span class="keyword">new</span> ElementSelector(<span class="string">"*/springProfile"</span>), <span class="keyword">new</span> SpringProfileAction(environment));</span><br><span class="line">		rs.addRule(<span class="keyword">new</span> ElementSelector(<span class="string">"*/springProfile/*"</span>), <span class="keyword">new</span> NOPAction());</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>不了解的胖友，可以先看看 <a href="https://www.cnblogs.com/jianliang-Wu/p/8945343.html" rel="external nofollow noopener noreferrer" target="_blank">《SpringBoot 中 logback.xml 使用 application.yml 中属性》</a> 文章。</li>
<li><a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/SpringProfileAction.java" rel="external nofollow noopener noreferrer" target="_blank"><validateCode>org.springframework.boot.logging.logback.SpringProfileAction</validateCode></a> ，处理 <validateCode>&lt;springProfile /&gt;</validateCode> 标签。</li>
<li><a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/SpringPropertyAction.java" rel="external nofollow noopener noreferrer" target="_blank"><validateCode>org.springframework.boot.logging.logback.SpringPropertyAction</validateCode></a> ，处理 <validateCode>&lt;springProperty /&gt;</validateCode> 标签。</li>
</ul>
<h4 id="7-4-3-2-reinitialize"><a href="#7-4-3-2-reinitialize" class="headerlink" title="7.4.3.2 reinitialize"></a>7.4.3.2 reinitialize</h4><p>实现 <validateCode>#reinitialize(LoggingInitializationContext initializationContext)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reinitialize</span><span class="params">(LoggingInitializationContext initializationContext)</span> </span>{</span><br><span class="line">	<span class="comment">// &lt;1&gt; 重置</span></span><br><span class="line">	getLoggerContext().reset();</span><br><span class="line">	<span class="comment">// &lt;2&gt; 清空 StatusManager</span></span><br><span class="line">	getLoggerContext().getStatusManager().clear();</span><br><span class="line">	<span class="comment">// &lt;3&gt; 加载配置</span></span><br><span class="line">	loadConfiguration(initializationContext, getSelfInitializationConfig(), <span class="keyword">null</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，重置。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，清空 StatusManager 。</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#loadConfiguration(LoggingInitializationContext initializationContext, String location, LogFile logFile)</validateCode> 方法，加载配置。此时，使用的是约定的 Logback 配置文件。</li>
</ul>
<h4 id="7-4-3-3-loadDefaults"><a href="#7-4-3-3-loadDefaults" class="headerlink" title="7.4.3.3 loadDefaults"></a>7.4.3.3 loadDefaults</h4><p>实现 <validateCode>#loadDefaults(LoggingInitializationContext initializationContext, LogFile logFile)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadDefaults</span><span class="params">(LoggingInitializationContext initializationContext, LogFile logFile)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 重置</span></span><br><span class="line">    LoggerContext context = getLoggerContext();</span><br><span class="line">    stopAndReset(context);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 创建 LogbackConfigurator 对象</span></span><br><span class="line">    LogbackConfigurator configurator = <span class="keyword">new</span> LogbackConfigurator(context);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 从 environment 读取变量，设置到 context 中。</span></span><br><span class="line">    Environment environment = initializationContext.getEnvironment();</span><br><span class="line">    context.putProperty(LoggingSystemProperties.LOG_LEVEL_PATTERN, environment.resolvePlaceholders(<span class="string">"${logging.pattern.level:${LOG_LEVEL_PATTERN:%5p}}"</span>));</span><br><span class="line">    context.putProperty(LoggingSystemProperties.LOG_DATEFORMAT_PATTERN, environment.resolvePlaceholders(<span class="string">"${logging.pattern.dateformat:${LOG_DATEFORMAT_PATTERN:yyyy-MM-dd HH:mm:ss.SSS}}"</span>));</span><br><span class="line">    <span class="comment">// &lt;4&gt; 创建 DefaultLogbackConfiguration 对象，设置到 configurator 中</span></span><br><span class="line">    <span class="keyword">new</span> DefaultLogbackConfiguration(initializationContext, logFile).apply(configurator);</span><br><span class="line">    <span class="comment">// &lt;5&gt; 设置日志文件，按天滚动</span></span><br><span class="line">    context.setPackagingDataEnabled(<span class="keyword">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#stopAndReset(LoggerContext loggerContext)</validateCode> 方法，重置。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，创建 LogbackConfigurator 对象。详细解析，见 <a href="#">「7.4.3.3.1 LogbackConfigurator」</a> 。</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，从 <validateCode>environment</validateCode> 读取变量，设置到 <validateCode>context</validateCode> 中。</li>
<li><validateCode>&lt;4&gt;</validateCode> 处，创建 DefaultLogbackConfiguration 对象，后调用 <validateCode>DefaultLogbackConfiguration#apply(LogbackConfigurator)</validateCode> 方法，设置到 <validateCode>configurator</validateCode> 中。详细解析，见 <a href="#">「7.4.3.3.2 DefaultLogbackConfiguration」</a> 。</li>
<li><validateCode>&lt;5&gt;</validateCode> 处，调用 <validateCode>LoggerContext#setPackagingDataEnabled(boolean packagingDataEnabled)</validateCode> 方法，设置日志文件，按天滚动。</li>
</ul>
<h5 id="7-4-3-3-1-LogbackConfigurator"><a href="#7-4-3-3-1-LogbackConfigurator" class="headerlink" title="7.4.3.3.1 LogbackConfigurator"></a>7.4.3.3.1 LogbackConfigurator</h5><p><validateCode>org.springframework.boot.logging.logback.LogbackConfigurator</validateCode> ，Logback 配置器，提供一些工具方法，方便配置 Logback 。</p>
<p>因为 LogbackConfigurator 提供的方法，都是被 DefaultLogbackConfiguration 所调用。所以我们先跳到 <a href="#">「7.4.3.3.2 DefaultLogbackConfiguration」</a> 中。</p>
<h6 id="7-4-3-3-1-1-conversionRule"><a href="#7-4-3-3-1-1-conversionRule" class="headerlink" title="7.4.3.3.1.1 conversionRule"></a>7.4.3.3.1.1 conversionRule</h6><p><validateCode>#conversionRule(String conversionWord, Class&lt;? extends Converter&gt; converterClass)</validateCode> 方法，添加转换规则。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">conversionRule</span><span class="params">(String conversionWord, Class&lt;? extends Converter&gt; converterClass)</span> </span>{</span><br><span class="line">    Assert.hasLength(conversionWord, <span class="string">"Conversion word must not be empty"</span>);</span><br><span class="line">    Assert.notNull(converterClass, <span class="string">"Converter class must not be null"</span>);</span><br><span class="line">    <span class="comment">// 获得注册表</span></span><br><span class="line">    Map&lt;String, String&gt; registry = (Map&lt;String, String&gt;) <span class="keyword">this</span>.context.getObject(CoreConstants.PATTERN_RULE_REGISTRY);</span><br><span class="line">    <span class="comment">// 如果注册表为空，则进行注册</span></span><br><span class="line">    <span class="keyword">if</span> (registry == <span class="keyword">null</span>) {</span><br><span class="line">        registry = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.context.putObject(CoreConstants.PATTERN_RULE_REGISTRY, registry);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 添加转换规则，到注册表中</span></span><br><span class="line">    registry.put(conversionWord, converterClass.getName());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>比较简单，胖友自己瞅瞅。</li>
<li>目前有三个转换规则，分别是：<ul>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/ColorConverter.java" rel="external nofollow noopener noreferrer" target="_blank">org.springframework.boot.logging.logback.ColorConverter</a> ，实现 ANSI 颜色转换器。</li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/ExtendedWhitespaceThrowableProxyConverter.java" rel="external nofollow noopener noreferrer" target="_blank">org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter</a> ，在异常堆栈的打印过程中添加一些空格。</li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/ExtendedWhitespaceThrowableProxyConverter.java" rel="external nofollow noopener noreferrer" target="_blank">org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter</a> ，在异常堆栈的打印过程中添加一些空格。</li>
<li><a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/logging/logback/WhitespaceThrowableProxyConverter.java" rel="external nofollow noopener noreferrer" target="_blank">org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter</a> ，在异常堆栈的打印过程中添加一些空格。【同上】</li>
<li>就不详细解析啦，胖友自己瞅瞅就明白列。 </li>
</ul>
</li>
</ul>
<h6 id="7-4-3-3-1-2-logger"><a href="#7-4-3-3-1-2-logger" class="headerlink" title="7.4.3.3.1.2 logger"></a>7.4.3.3.1.2 logger</h6><p><validateCode>#logger(String name, Level level)</validateCode> 方法，添加 Logger 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logger</span><span class="params">(String name, Level level)</span> </span>{</span><br><span class="line">    logger(name, level, <span class="keyword">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logger</span><span class="params">(String name, Level level, <span class="keyword">boolean</span> additive)</span> </span>{</span><br><span class="line">    logger(name, level, additive, <span class="keyword">null</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logger</span><span class="params">(String name, Level level, <span class="keyword">boolean</span> additive, Appender&lt;ILoggingEvent&gt; appender)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得 Logger 对象</span></span><br><span class="line">    Logger logger = <span class="keyword">this</span>.context.getLogger(name);</span><br><span class="line">    <span class="comment">// 设置 level</span></span><br><span class="line">    <span class="keyword">if</span> (level != <span class="keyword">null</span>) {</span><br><span class="line">        logger.setLevel(level);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 设置 additive</span></span><br><span class="line">    logger.setAdditive(additive);</span><br><span class="line">    <span class="comment">// 设置 appender</span></span><br><span class="line">    <span class="keyword">if</span> (appender != <span class="keyword">null</span>) {</span><br><span class="line">        logger.addAppender(appender);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="7-4-3-3-1-3-appender"><a href="#7-4-3-3-1-3-appender" class="headerlink" title="7.4.3.3.1.3 appender"></a>7.4.3.3.1.3 appender</h6><p><validateCode>#appender(String name, Appender&lt;?&gt; appender)</validateCode> 方法，启动 Appender 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appender</span><span class="params">(String name, Appender&lt;?&gt; appender)</span> </span>{</span><br><span class="line">	<span class="comment">// 设置 name</span></span><br><span class="line">	appender.setName(name);</span><br><span class="line">	<span class="comment">// 启动 Appender</span></span><br><span class="line">	start(appender);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(LifeCycle lifeCycle)</span> </span>{</span><br><span class="line">    <span class="comment">// 设置 context</span></span><br><span class="line">    <span class="keyword">if</span> (lifeCycle <span class="keyword">instanceof</span> ContextAware) {</span><br><span class="line">        ((ContextAware) lifeCycle).setContext(<span class="keyword">this</span>.context);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 启动</span></span><br><span class="line">    lifeCycle.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="7-4-3-3-1-4-root"><a href="#7-4-3-3-1-4-root" class="headerlink" title="7.4.3.3.1.4 root"></a>7.4.3.3.1.4 root</h6><p><validateCode>#root(Level level, Appender&lt;ILoggingEvent&gt;... appenders)</validateCode> 方法，设置 appender 到 ROOT Logger 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">root</span><span class="params">(Level level, Appender&lt;ILoggingEvent&gt;... appenders)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得 Root Logger 对象</span></span><br><span class="line">    Logger logger = <span class="keyword">this</span>.context.getLogger(org.slf4j.Logger.ROOT_LOGGER_NAME);</span><br><span class="line">    <span class="comment">// 设置 level</span></span><br><span class="line">    <span class="keyword">if</span> (level != <span class="keyword">null</span>) {</span><br><span class="line">        logger.setLevel(level);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 添加 appender 到 logger 中</span></span><br><span class="line">    <span class="keyword">for</span> (Appender&lt;ILoggingEvent&gt; appender : appenders) {</span><br><span class="line">        logger.addAppender(appender);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="7-4-3-3-2-DefaultLogbackConfiguration"><a href="#7-4-3-3-2-DefaultLogbackConfiguration" class="headerlink" title="7.4.3.3.2 DefaultLogbackConfiguration"></a>7.4.3.3.2 DefaultLogbackConfiguration</h5><p><validateCode>org.springframework.boot.logging.logback.DefaultLogbackConfiguration</validateCode> ，默认的 Logback 配置类。代码如下：</p>
<blockquote>
<p>相当于代码生成 <validateCode>logback.xml</validateCode> 的效果。</p>
</blockquote>
<h5 id="7-4-3-3-2-1-构造方法"><a href="#7-4-3-3-2-1-构造方法" class="headerlink" title="7.4.3.3.2.1 构造方法"></a>7.4.3.3.2.1 构造方法</h5><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// DefaultLogbackConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PropertyResolver 对象。提供从 environment 解析配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PropertyResolver patterns;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LogFile logFile;</span><br><span class="line"></span><br><span class="line">DefaultLogbackConfiguration(LoggingInitializationContext initializationContext, LogFile logFile) {</span><br><span class="line">    <span class="keyword">this</span>.patterns = getPatternsResolver(initializationContext.getEnvironment());</span><br><span class="line">    <span class="keyword">this</span>.logFile = logFile;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PropertyResolver <span class="title">getPatternsResolver</span><span class="params">(Environment environment)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建 PropertySourcesPropertyResolver 对象，无 environment</span></span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PropertySourcesPropertyResolver(<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 创建 PropertySourcesPropertyResolver 对象，有 environment</span></span><br><span class="line">    <span class="keyword">if</span> (environment <span class="keyword">instanceof</span> ConfigurableEnvironment) {</span><br><span class="line">        PropertySourcesPropertyResolver resolver = <span class="keyword">new</span> PropertySourcesPropertyResolver(((ConfigurableEnvironment) environment).getPropertySources());</span><br><span class="line">        resolver.setIgnoreUnresolvableNestedPlaceholders(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 直接返回 environment</span></span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="7-4-3-3-2-2-apply"><a href="#7-4-3-3-2-2-apply" class="headerlink" title="7.4.3.3.2.2 apply"></a>7.4.3.3.2.2 apply</h5><p><validateCode>#apply(LogbackConfigurator config)</validateCode> 方法，应用配置。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// DefaultLogbackConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(LogbackConfigurator config)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 锁</span></span><br><span class="line">    <span class="keyword">synchronized</span> (config.getConfigurationLock()) {</span><br><span class="line">        <span class="comment">// &lt;2&gt; 设置基础属性</span></span><br><span class="line">        base(config);</span><br><span class="line">        <span class="comment">// &lt;3&gt; 创建 console Appender</span></span><br><span class="line">        Appender&lt;ILoggingEvent&gt; consoleAppender = consoleAppender(config);</span><br><span class="line">        <span class="comment">// &lt;4&gt; 如果 logFile 非空，则创建 file Appender</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logFile != <span class="keyword">null</span>) {</span><br><span class="line">            Appender&lt;ILoggingEvent&gt; fileAppender = fileAppender(config, <span class="keyword">this</span>.logFile.toString());</span><br><span class="line">            <span class="comment">// &lt;5&gt; 设置 appender 到 ROOT Logger</span></span><br><span class="line">            config.root(Level.INFO, consoleAppender, fileAppender);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// &lt;5&gt; 设置 appender 到 ROOT Logger</span></span><br><span class="line">            config.root(Level.INFO, consoleAppender);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，锁。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LoggerContext context;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getConfigurationLock</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.context.getConfigurationLock();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#base(LogbackConfigurator config)</validateCode> 方法，设置基础属性。代码如下： </p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">base</span><span class="params">(LogbackConfigurator config)</span> </span>{</span><br><span class="line">	<span class="comment">// &lt;2.1&gt; Converter</span></span><br><span class="line">	config.conversionRule(<span class="string">"clr"</span>, ColorConverter.class);</span><br><span class="line">	config.conversionRule(<span class="string">"wex"</span>, WhitespaceThrowableProxyConverter.class);</span><br><span class="line">	config.conversionRule(<span class="string">"wEx"</span>, ExtendedWhitespaceThrowableProxyConverter.class);</span><br><span class="line">	<span class="comment">// &lt;2.2&gt; 默认的 logger</span></span><br><span class="line">	config.logger(<span class="string">"org.apache.catalina.startup.DigesterFactory"</span>, Level.ERROR);</span><br><span class="line">	config.logger(<span class="string">"org.apache.catalina.util.LifecycleBase"</span>, Level.ERROR);</span><br><span class="line">	config.logger(<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>, Level.WARN);</span><br><span class="line">	config.logger(<span class="string">"org.apache.sshd.common.util.SecurityUtils"</span>, Level.WARN);</span><br><span class="line">	config.logger(<span class="string">"org.apache.tomcat.util.net.NioSelectorPool"</span>, Level.WARN);</span><br><span class="line">	config.logger(<span class="string">"org.eclipse.jetty.util.component.AbstractLifeCycle"</span>, Level.ERROR);</span><br><span class="line">	config.logger(<span class="string">"org.hibernate.validator.internal.util.Version"</span>, Level.WARN);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;2.1&gt;</validateCode> 处，调用 <validateCode>LogbackConfigurator#conversionRule(String conversionWord, Class&lt;? extends Converter&gt; converterClass)</validateCode> 方法，添加转换规则。详细解析，见 <a href="#">「 7.4.3.3.1.1 conversionRule」</a> 。</li>
<li><validateCode>&lt;2.2&gt;</validateCode> 处，调用 <validateCode>LogbackConfigurator#logger(String name, Level level)</validateCode> 方法，默认的 logger 。详细解析，见 <a href="#">「7.4.3.3.1.2 logger」</a> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#consoleAppender(LogbackConfigurator config)</validateCode> 方法，创建 console Appender 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONSOLE_LOG_PATTERN = <span class="string">"%clr(%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS}}){faint} "</span></span><br><span class="line">		+ <span class="string">"%clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} "</span></span><br><span class="line">		+ <span class="string">"%clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} "</span></span><br><span class="line">		+ <span class="string">"%clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Appender&lt;ILoggingEvent&gt; <span class="title">consoleAppender</span><span class="params">(LogbackConfigurator config)</span> </span>{</span><br><span class="line">	ConsoleAppender&lt;ILoggingEvent&gt; appender = <span class="keyword">new</span> ConsoleAppender&lt;&gt;();</span><br><span class="line">	PatternLayoutEncoder encoder = <span class="keyword">new</span> PatternLayoutEncoder();</span><br><span class="line">	String logPattern = <span class="keyword">this</span>.patterns.getProperty(<span class="string">"logging.pattern.console"</span>, CONSOLE_LOG_PATTERN); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">	encoder.setPattern(OptionHelper.substVars(logPattern, config.getContext()));</span><br><span class="line">	config.start(encoder);</span><br><span class="line">	appender.setEncoder(encoder);</span><br><span class="line">	config.appender(<span class="string">"CONSOLE"</span>, appender); <span class="comment">// &lt;Y&gt;</span></span><br><span class="line">	<span class="keyword">return</span> appender;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，从 <validateCode>environment</validateCode> 中，读取 <validateCode>"logging.pattern.console"</validateCode> 作为格式。如果找不到，使用 <validateCode>CONSOLE_LOG_PATTERN</validateCode> 。</li>
<li><validateCode>&lt;Y&gt;</validateCode> 处，调用 <validateCode>LogbackConfigurator#appender(String name, Appender&lt;?&gt; appender)</validateCode> 方法，启动 Appender 。详细解析，见 <a href="#">「7.4.3.3.1.3 appender」</a> 。</li>
</ul>
</li>
<li><p><validateCode>&lt;4&gt;</validateCode> 处，如果 <validateCode>logFile</validateCode> 非空，则调用 <validateCode>#fileAppender(LogbackConfigurator config, String logFile)</validateCode> 方法，创建 file Appender。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"> <span class="comment">// LogbackConfigurator.java</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_LOG_PATTERN = <span class="string">"%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS}} "</span></span><br><span class="line">+ <span class="string">"${LOG_LEVEL_PATTERN:-%5p} ${PID:- } --- [%t] %-40.40logger{39} : %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAX_FILE_SIZE = <span class="string">"10MB"</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> Appender&lt;ILoggingEvent&gt; <span class="title">fileAppender</span><span class="params">(LogbackConfigurator config, String logFile)</span> </span>{</span><br><span class="line"> 	RollingFileAppender&lt;ILoggingEvent&gt; appender = <span class="keyword">new</span> RollingFileAppender&lt;&gt;();</span><br><span class="line"> 	PatternLayoutEncoder encoder = <span class="keyword">new</span> PatternLayoutEncoder();</span><br><span class="line"> 	String logPattern = <span class="keyword">this</span>.patterns.getProperty(<span class="string">"logging.pattern.file"</span>, FILE_LOG_PATTERN);</span><br><span class="line"> 	encoder.setPattern(OptionHelper.substVars(logPattern, config.getContext()));</span><br><span class="line"> 	appender.setEncoder(encoder);</span><br><span class="line"> 	config.start(encoder);</span><br><span class="line"> 	appender.setFile(logFile);</span><br><span class="line"> 	<span class="comment">// 滚动策略</span></span><br><span class="line"> 	setRollingPolicy(appender, config, logFile);</span><br><span class="line"> 	config.appender(<span class="string">"FILE"</span>, appender);</span><br><span class="line"> 	<span class="keyword">return</span> appender;</span><br><span class="line"> }</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setRollingPolicy</span><span class="params">(RollingFileAppender&lt;ILoggingEvent&gt; appender, LogbackConfigurator config, String logFile)</span> </span>{</span><br><span class="line"> 	SizeAndTimeBasedRollingPolicy&lt;ILoggingEvent&gt; rollingPolicy = <span class="keyword">new</span> SizeAndTimeBasedRollingPolicy&lt;&gt;();</span><br><span class="line"> 	rollingPolicy.setFileNamePattern(logFile + <span class="string">".%d{yyyy-MM-dd}.%i.gz"</span>);</span><br><span class="line"> 	<span class="comment">// 单文件最大值</span></span><br><span class="line"> 	setMaxFileSize(rollingPolicy, <span class="keyword">this</span>.patterns.getProperty(<span class="string">"logging.file.max-size"</span>, MAX_FILE_SIZE));</span><br><span class="line"> 	rollingPolicy.setMaxHistory(<span class="keyword">this</span>.patterns.getProperty(<span class="string">"logging.file.max-history"</span>, Integer.class, CoreConstants.UNBOUND_HISTORY));</span><br><span class="line"> 	appender.setRollingPolicy(rollingPolicy);</span><br><span class="line"> 	rollingPolicy.setParent(appender);</span><br><span class="line"> 	config.start(rollingPolicy);</span><br><span class="line"> }</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMaxFileSize</span><span class="params">(SizeAndTimeBasedRollingPolicy&lt;ILoggingEvent&gt; rollingPolicy, String maxFileSize)</span> </span>{</span><br><span class="line"> 	<span class="keyword">try</span> {</span><br><span class="line"> 		rollingPolicy.setMaxFileSize(FileSize.valueOf(maxFileSize));</span><br><span class="line"> 	} <span class="keyword">catch</span> (NoSuchMethodError ex) {</span><br><span class="line"> 		<span class="comment">// Logback &lt; 1.1.8 used String configuration</span></span><br><span class="line"> 		Method method = ReflectionUtils.findMethod(SizeAndTimeBasedRollingPolicy.class, <span class="string">"setMaxFileSize"</span>, String.class);</span><br><span class="line"> 		ReflectionUtils.invokeMethod(method, rollingPolicy, maxFileSize);</span><br><span class="line"> 	}</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><validateCode>&lt;5&gt;</validateCode> 处，调用 <validateCode>LogbackConfigurator#root(Level level, Appender&lt;ILoggingEvent&gt;... appenders)</validateCode> 方法，设置 appender 到 ROOT Logger 。详细解析，见 <a href="#">「7.4.3.3.1.4 root」</a> 。</p>
</li>
</ul>
<h3 id="7-4-4-setLogLevel"><a href="#7-4-4-setLogLevel" class="headerlink" title="7.4.4 setLogLevel"></a>7.4.4 setLogLevel</h3><p>实现 <validateCode>#setLogLevel(String loggerName, LogLevel level)</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LogLevels&lt;Level&gt; LEVELS = <span class="keyword">new</span> LogLevels&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">	LEVELS.map(LogLevel.TRACE, Level.TRACE);</span><br><span class="line">	LEVELS.map(LogLevel.TRACE, Level.ALL);</span><br><span class="line">	LEVELS.map(LogLevel.DEBUG, Level.DEBUG);</span><br><span class="line">	LEVELS.map(LogLevel.INFO, Level.INFO);</span><br><span class="line">	LEVELS.map(LogLevel.WARN, Level.WARN);</span><br><span class="line">	LEVELS.map(LogLevel.ERROR, Level.ERROR);</span><br><span class="line">	LEVELS.map(LogLevel.FATAL, Level.ERROR);</span><br><span class="line">	LEVELS.map(LogLevel.OFF, Level.OFF);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogLevel</span><span class="params">(String loggerName, LogLevel level)</span> </span>{</span><br><span class="line">	<span class="comment">// &lt;1&gt; 获得 Logger 对象</span></span><br><span class="line">	ch.qos.logback.classic.Logger logger = getLogger(loggerName);</span><br><span class="line">	<span class="comment">// &lt;2&gt; 设置日志级别</span></span><br><span class="line">	<span class="keyword">if</span> (logger != <span class="keyword">null</span>) {</span><br><span class="line">		logger.setLevel(LEVELS.convertSystemToNative(level));</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getLogger(String name)</validateCode> 方法，获得 Logger 对象。代码如下：  <figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ch.qos.logback.classic.<span class="function">Logger <span class="title">getLogger</span><span class="params">(String name)</span> </span>{</span><br><span class="line">	LoggerContext factory = getLoggerContext();</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isEmpty(name) || ROOT_LOGGER_NAME.equals(name)) {</span><br><span class="line">		name = Logger.ROOT_LOGGER_NAME;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> factory.getLogger(name);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><validateCode>&lt;2&gt;</validateCode> 处，设置日志级别。</li>
</ul>
<h3 id="7-4-4-cleanUp"><a href="#7-4-4-cleanUp" class="headerlink" title="7.4.4 cleanUp"></a>7.4.4 cleanUp</h3><p>重写 <validateCode>#cleanUp()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanUp</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="comment">// 标记为未初始化</span></span><br><span class="line">	LoggerContext context = getLoggerContext();</span><br><span class="line">	markAsUninitialized(context);</span><br><span class="line">	<span class="comment">// 调用父方法</span></span><br><span class="line">	<span class="keyword">super</span>.cleanUp();</span><br><span class="line">	<span class="comment">// 清空 StatusManager</span></span><br><span class="line">	context.getStatusManager().clear();</span><br><span class="line">	<span class="comment">// 移除 FILTER</span></span><br><span class="line">	context.getTurboFilterList().remove(FILTER);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markAsUninitialized</span><span class="params">(LoggerContext loggerContext)</span> </span>{</span><br><span class="line">	loggerContext.removeObject(LoggingSystem.class.getName());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-4-5-getShutdownHandler"><a href="#7-4-5-getShutdownHandler" class="headerlink" title="7.4.5 getShutdownHandler"></a>7.4.5 getShutdownHandler</h3><p>实现 <validateCode>#getShutdownHandler()</validateCode> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// LogbackLoggingSystem.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Runnable <span class="title">getShutdownHandler</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ShutdownHandler();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShutdownHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">		getLoggerContext().stop(); <span class="comment">// 停止</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-5-Log4J2LoggingSystem"><a href="#7-5-Log4J2LoggingSystem" class="headerlink" title="7.5 Log4J2LoggingSystem"></a>7.5 Log4J2LoggingSystem</h2><p><validateCode>org.springframework.boot.logging.log4j2.Log4J2LoggingSystem</validateCode> ，继承 Slf4JLoggingSystem 抽象类，基于 Log4J2 的 LoggingSystem 实现类。 </p>
<p>就暂时不解析了，基本类似。感兴趣的胖友，可以看看 <a href="https://blog.csdn.net/qq_26000415/article/details/79109517" rel="external nofollow noopener noreferrer" target="_blank">《spring boot 源码解析28-Log4J2LoggingSystem》</a> 。</p>
<h2 id="7-6-JavaLoggingSystem"><a href="#7-6-JavaLoggingSystem" class="headerlink" title="7.6 JavaLoggingSystem"></a>7.6 JavaLoggingSystem</h2><p><validateCode>org.springframework.boot.logging.java.JavaLoggingSystem</validateCode> ，继承 AbstractLoggingSystem 抽象类，基于 JUL 的 LoggingSystem 实现类。</p>
<p>就暂时不解析了，基本类似。感兴趣的胖友，可以看看 <a href="https://blog.csdn.net/qq_26000415/article/details/79103989" rel="external nofollow noopener noreferrer" target="_blank">《spring boot 源码解析27-JavaLoggingSystem及LoggingSystem生命周期详解》</a> 的 <a href="#">「LoggingSystem」</a> 部分。</p>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>Spring Boot 的文章，基本都短不了~咋说呢？虽然长了一些吧，总体还是比较简单和顺畅的。</p>
<p>参考和推荐如下文章：</p>
<ul>
<li>一个努力的码农 <a href="https://blog.csdn.net/qq_26000415/article/details/79130943" rel="external nofollow noopener noreferrer" target="_blank">《spring boot 源码解析29-LogbackLoggingSystem》</a></li>
<li>oldflame-Jm <a href="https://blog.csdn.net/jamet/article/details/78060817" rel="external nofollow noopener noreferrer" target="_blank">《Spring boot源码分析-log日志系统（6）》</a></li>
</ul>




</div>