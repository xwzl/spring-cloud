<div class="article-entry" itemprop="articleBody">

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文接 <a href="http://svip.iocoder.cn/Spring-Boot/ServletWebServerApplicationContext">《精尽 Spring Boot 源码分析 —— ServletWebServerApplicationContext》</a> 一文，我们来分享 ReactiveWebServerApplicationContext 类，它提供 Reactive Web 环境的 Spring 容器。</p>
<p>AnnotationConfigReactiveWebServerApplicationContext 的类图关系如下：<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-19/01.jpg" alt="类图"></p>
<ul>
<li>相比来说，ReactiveWebServerApplicationContext 比 ServletWebServerApplicationContext 有更多的层级关系。不过没事，我们一点一点来看。</li>
</ul>
<blockquote>
<p>艿艿：Spring Webflux ，我自己目前没太使用过。看这块，就单纯好奇下，哈哈哈。</p>
</blockquote>
<h1 id="2-ReactiveWebApplicationContext"><a href="#2-ReactiveWebApplicationContext" class="headerlink" title="2. ReactiveWebApplicationContext"></a>2. ReactiveWebApplicationContext</h1><p><validateCode>org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext</validateCode> ，继承 ApplicationContext 接口，Reactive Web ApplicationContext 接口。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-ConfigurableReactiveWebApplicationContext"><a href="#3-ConfigurableReactiveWebApplicationContext" class="headerlink" title="3. ConfigurableReactiveWebApplicationContext"></a>3. ConfigurableReactiveWebApplicationContext</h1><p><validateCode>org.springframework.boot.web.reactive.context.ConfigurableReactiveWebApplicationContext</validateCode> ，继承 ConfigurableApplicationContext、<a href="#">「2. ReactiveWebApplicationContext」</a> 接口，可配置的 ReactiveWebApplicationContext 接口。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">ConfigurableApplicationContext</span>, <span class="title">ReactiveWebApplicationContext</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-GenericReactiveWebApplicationContext"><a href="#4-GenericReactiveWebApplicationContext" class="headerlink" title="4. GenericReactiveWebApplicationContext"></a>4. GenericReactiveWebApplicationContext</h1><p><validateCode>org.springframework.boot.web.reactive.context.GenericReactiveWebApplicationContext</validateCode> ，实现 <a href="#">「3. ConfigurableReactiveWebApplicationContext」</a> 接口，继承 GenericApplicationContext 类，通用的 Reactive Web ApplicationContext 实现类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// GenericReactiveWebApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericReactiveWebApplicationContext</span> <span class="keyword">extends</span> <span class="title">GenericApplicationContext</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ConfigurableReactiveWebApplicationContext</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericReactiveWebApplicationContext</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericReactiveWebApplicationContext</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(beanFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 覆写 AbstractApplicationContext 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableEnvironment <span class="title">createEnvironment</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StandardReactiveWebEnvironment(); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 覆写 AbstractApplicationContext 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>{</span><br><span class="line">        <span class="comment">// We must be careful not to expose classpath resources</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FilteredReactiveWebContextResource(path); <span class="comment">// &lt;Y&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>重点在 <validateCode>&lt;X&gt;</validateCode> 和 <validateCode>&lt;Y&gt;</validateCode> 处，覆写了方法，分别返回了 StandardReactiveWebEnvironment 和 FilteredReactiveWebContextResource 对象。不过看了下这两个对象，暂时也没什么特殊的方法。所以，可暂时忽略~</li>
</ul>
<h1 id="5-ReactiveWebServerApplicationContext"><a href="#5-ReactiveWebServerApplicationContext" class="headerlink" title="5. ReactiveWebServerApplicationContext"></a>5. ReactiveWebServerApplicationContext</h1><blockquote>
<p>艿艿：正戏开始~</p>
</blockquote>
<p><validateCode>org.springframework.boot.web.reactive.context.ReactiveWebServerApplicationContext</validateCode> ，实现 ConfigurableWebServerApplicationContext 接口，继承 GenericReactiveWebApplicationContext 类，Spring Boot 使用 Reactive Web 服务器的 ApplicationContext 实现类。</p>
<h2 id="5-1-构造方法"><a href="#5-1-构造方法" class="headerlink" title="5.1 构造方法"></a>5.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServerManager 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ServerManager serverManager;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过 {<span class="doctag">@link</span> #setServerNamespace(String)} 注入。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 不过貌似，一直没被注入过，可以暂时先无视</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String serverNamespace;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReactiveWebServerApplicationContext</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReactiveWebServerApplicationContext</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(beanFactory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>serverManager</validateCode> 属性，ServerManager 对象。详细解析，见 <a href="#">「5.2 ServerManager」</a> 。</li>
</ul>
<h2 id="5-2-ServerManager"><a href="#5-2-ServerManager" class="headerlink" title="5.2 ServerManager"></a>5.2 ServerManager</h2><p>ServerManager 是 ReactiveWebServerApplicationContext 的内部静态类，实现 <validateCode>org.springframework.http.server.reactive.HttpHandler</validateCode> 接口，内含 Server 的管理器。</p>
<h3 id="5-2-1-构造方法"><a href="#5-2-1-构造方法" class="headerlink" title="5.2.1 构造方法"></a>5.2.1 构造方法</h3><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebServer 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebServer server;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HttpHandler 对象，具体在 {<span class="doctag">@link</span> #handle(ServerHttpRequest, ServerHttpResponse)} 方法中使用。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> HttpHandler handler;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ServerManager</span><span class="params">(ReactiveWebServerFactory factory)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.handler = <span class="keyword">this</span>::handleUninitialized; <span class="comment">// &lt;1&gt; 同下面</span></span><br><span class="line"><span class="comment">//          this.handler = new HttpHandler() {</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public Mono&lt;Void&gt; handle(ServerHttpRequest request, ServerHttpResponse response) {</span></span><br><span class="line"><span class="comment">//                    return handleUninitialized(request, response);</span></span><br><span class="line"><span class="comment">//                }</span></span><br><span class="line"><span class="comment">//            };</span></span><br><span class="line">    <span class="keyword">this</span>.server = factory.getWebServer(<span class="keyword">this</span>); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">handleUninitialized</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The HttpHandler has not yet been initialized"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，创建的 <validateCode>handler</validateCode> 对象，内部实现调用了 <validateCode>#handleUninitialized(ServerHttpRequest request, ServerHttpResponse response)</validateCode> 方法，会抛出 IllegalStateException 异常。表示，此时该 <validateCode>server</validateCode> 还不可用。因为，<validateCode>server</validateCode> 都还没启动。😈 </li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>ReactiveWebServerFactory#getWebServer(HttpHandler handler)</validateCode> 方法，创建 WebServer 对象。其中，方法参数 <validateCode>handler</validateCode> 传递是 <validateCode>this</validateCode> 自己，因为后面的请求处理的 <validateCode>#handle(ServerHttpRequest request, ServerHttpResponse)</validateCode> 方法，需要调用自己哟。</li>
</ul>
<h3 id="5-2-2-handle"><a href="#5-2-2-handle" class="headerlink" title="5.2.2 handle"></a>5.2.2 handle</h3><p>实现 <validateCode>#handle(ServerHttpRequest request, ServerHttpResponse)</validateCode> 方法，处理请求。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.handler.handle(request, response);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>委托给 <validateCode>handler</validateCode> 属性，对应的方法，处理请求。</li>
</ul>
<h3 id="5-2-3-get"><a href="#5-2-3-get" class="headerlink" title="5.2.3 get"></a>5.2.3 get</h3><p><validateCode>#get(ReactiveWebServerFactory factory)</validateCode> <strong>静态</strong>方法，创建一个 ServerManager 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServerManager <span class="title">get</span><span class="params">(ReactiveWebServerFactory factory)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ServerManager(factory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-2-4-getWebServer"><a href="#5-2-4-getWebServer" class="headerlink" title="5.2.4 getWebServer"></a>5.2.4 getWebServer</h3><p><validateCode>#getWebServer(ServerManager manager)</validateCode> <strong>静态</strong>方法，获得 <validateCode>manager</validateCode> 的 WebServer 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebServer <span class="title">getWebServer</span><span class="params">(ServerManager manager)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> (manager != <span class="keyword">null</span>) ? manager.server : <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-2-5-start"><a href="#5-2-5-start" class="headerlink" title="5.2.5 start"></a>5.2.5 start</h3><p><validateCode>#start(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</validateCode> <strong>静态</strong>方法，启动。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (manager != <span class="keyword">null</span> &amp;&amp; manager.server != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; 赋值 handler</span></span><br><span class="line">        manager.handler = handlerSupplier.get();</span><br><span class="line">        <span class="comment">// &lt;2&gt; 启动 server</span></span><br><span class="line">        manager.server.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，将 <validateCode>handlerSupplier</validateCode> 赋值给 <validateCode>manager.handler</validateCode> 。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>WebServer#start()</validateCode> 方法，启动 Server 。</li>
</ul>
<h3 id="5-2-6-stop"><a href="#5-2-6-stop" class="headerlink" title="5.2.6 stop"></a>5.2.6 stop</h3><p><validateCode>#stop(ServerManager manager)</validateCode> <strong>静态</strong>方法，停止。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext#ServerManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(ServerManager manager)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (manager != <span class="keyword">null</span> &amp;&amp; manager.server != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			manager.server.stop();</span><br><span class="line">		} <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>调用 <validateCode>ServerManager#stop()</validateCode> 方法，停止 Server 。</li>
</ul>
<blockquote>
<p>😈 到此时，可能胖友有点懵逼。没事，我们下面看看 ReactiveWebServerApplicationContext 怎么使用它。</p>
</blockquote>
<h2 id="5-3-refresh"><a href="#5-3-refresh" class="headerlink" title="5.3 refresh"></a>5.3 refresh</h2><p>覆写 <validateCode>#refresh()</validateCode> 方法，初始化 Spring 容器。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 调用父方法</span></span><br><span class="line">        <span class="keyword">super</span>.refresh();</span><br><span class="line">    } <span class="keyword">catch</span> (RuntimeException ex) {</span><br><span class="line">        <span class="comment">// &lt;X&gt; 停止 Reactive WebServer</span></span><br><span class="line">        stopAndReleaseReactiveWebServer();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>主要是 <validateCode>&lt;X&gt;</validateCode> 处，如果发生异常，则调用 <validateCode>#stopAndReleaseWebServer()</validateCode> 方法，停止 WebServer。详细解析，见 <a href="#">「5.3.1 stopAndReleaseWebServer」</a> 。</li>
</ul>
<h3 id="5-3-1-stopAndReleaseWebServer"><a href="#5-3-1-stopAndReleaseWebServer" class="headerlink" title="5.3.1 stopAndReleaseWebServer"></a>5.3.1 stopAndReleaseWebServer</h3><p><validateCode>#stopAndReleaseWebServer()</validateCode> 方法，停止 WebServer。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopAndReleaseReactiveWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">	ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		ServerManager.stop(serverManager); <span class="comment">// &lt;Y&gt;</span></span><br><span class="line">	} <span class="keyword">finally</span> {</span><br><span class="line">		<span class="keyword">this</span>.serverManager = <span class="keyword">null</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;Y&gt;</validateCode> 处，调用 <validateCode>ServerManager#stop(serverManager)</validateCode> 方法，停止 WebServer 。</li>
</ul>
<h2 id="5-4-onRefresh"><a href="#5-4-onRefresh" class="headerlink" title="5.4 onRefresh"></a>5.4 onRefresh</h2><p>覆写 <validateCode>#onRefresh()</validateCode> 方法，在容器初始化时，完成 WebServer 的创建（不包括启动）。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 调用父方法</span></span><br><span class="line">    <span class="keyword">super</span>.onRefresh();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;2&gt; 创建 WebServer</span></span><br><span class="line">        createWebServer();</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start reactive web server"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用父 <validateCode>#onRefresh()</validateCode> 方法，执行父逻辑。这块，暂时不用了解。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#createWebServer()</validateCode> 方法，创建 WebServer 对象。详细解析，见 <a href="#">「5.4.1 createWebServer」</a> 。</li>
</ul>
<h3 id="5-4-1-createWebServer"><a href="#5-4-1-createWebServer" class="headerlink" title="5.4.1 createWebServer"></a>5.4.1 createWebServer</h3><p><validateCode>#createWebServer()</validateCode> 方法，创建 WebServer 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="comment">// 获得 ServerManager 对象。</span></span><br><span class="line">	ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">	<span class="comment">// 如果不存在，则进行初始化</span></span><br><span class="line">	<span class="keyword">if</span> (serverManager == <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.serverManager = ServerManager.get(getWebServerFactory()); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;2&gt; 初始化 PropertySource</span></span><br><span class="line">	initPropertySources();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getWebServerFactory()</validateCode> 方法，获得 ReactiveWebServerFactory 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ReactiveWebServerFactory <span class="title">getWebServerFactory</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Use bean names so that we don't consider the hierarchy</span></span><br><span class="line">    <span class="comment">// 获得 ServletWebServerFactory 类型对应的 Bean 的名字们</span></span><br><span class="line">    String[] beanNames = getBeanFactory().getBeanNamesForType(ReactiveWebServerFactory.class);</span><br><span class="line">    <span class="comment">// 如果是 0 个，抛出 ApplicationContextException 异常，因为至少要一个</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to missing "</span> + <span class="string">"ReactiveWebServerFactory bean."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 如果是 &gt; 1 个，抛出 ApplicationContextException 异常，因为不知道初始化哪个</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to multiple "</span></span><br><span class="line">                        + <span class="string">"ReactiveWebServerFactory beans : "</span> + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获得 ReactiveWebServerFactory 类型对应的 Bean 对象</span></span><br><span class="line">    <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ReactiveWebServerFactory.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>默认情况下，此处返回的会是 <validateCode>org.springframework.boot.web.embedded.netty.NettyReactiveWebServerFactory</validateCode> 对象。</li>
<li>在我们引入 <validateCode>spring-boot-starter-webflux</validateCode> 依赖时，<validateCode>org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryConfiguration</validateCode> 在自动配置时，会配置出 NettyReactiveWebServerFactory Bean 对象。因此，此时会获得 NettyReactiveWebServerFactory 对象。</li>
</ul>
</li>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>ServerManager#get(ReactiveWebServerFactory)</validateCode> <strong>静态</strong>方法，创建 ServerManager 对象。</p>
</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用父 <validateCode>#initPropertySources()</validateCode> 方法，初始化 PropertySource 。</li>
</ul>
<h2 id="5-5-finishRefresh"><a href="#5-5-finishRefresh" class="headerlink" title="5.5 finishRefresh"></a>5.5 finishRefresh</h2><p>覆写 <validateCode>#finishRefresh()</validateCode> 方法，在容器初始化完成时，启动 WebServer 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 调用父方法</span></span><br><span class="line">    <span class="keyword">super</span>.finishRefresh();</span><br><span class="line">    <span class="comment">// &lt;2&gt; 启动 WebServer</span></span><br><span class="line">    WebServer webServer = startReactiveWebServer();</span><br><span class="line">    <span class="comment">// &lt;3&gt; 如果创建 WebServer 成功，发布 ReactiveWebServerInitializedEvent 事件</span></span><br><span class="line">    <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) {</span><br><span class="line">        publishEvent(<span class="keyword">new</span> ReactiveWebServerInitializedEvent(webServer, <span class="keyword">this</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#finishRefresh()</validateCode> 方法，执行父逻辑。这块，暂时不用了解。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#startReactiveWebServer()</validateCode> 方法，启动 WebServer 。详细解析，见 <a href="#">「5.5.1 startReactiveWebServer」</a> 。</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，如果创建 WebServer 成功，发布 ReactiveWebServerInitializedEvent 事件。</li>
</ul>
<h3 id="5-5-1-startReactiveWebServer"><a href="#5-5-1-startReactiveWebServer" class="headerlink" title="5.5.1 startReactiveWebServer"></a>5.5.1 startReactiveWebServer</h3><p><validateCode>#startReactiveWebServer()</validateCode> 方法，启动 WebServer 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WebServer <span class="title">startReactiveWebServer</span><span class="params">()</span> </span>{</span><br><span class="line">    ServerManager serverManager = <span class="keyword">this</span>.serverManager;</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得 HttpHandler</span></span><br><span class="line">    <span class="comment">// &lt;2&gt; 启动 WebServer</span></span><br><span class="line">    ServerManager.start(serverManager, <span class="keyword">this</span>::getHttpHandler);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 获得 WebServer</span></span><br><span class="line">    <span class="keyword">return</span> ServerManager.getWebServer(serverManager);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getHttpHandler()</validateCode> 方法，获得 HttpHandler 对象。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HttpHandler <span class="title">getHttpHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Use bean names so that we don't consider the hierarchy</span></span><br><span class="line">    <span class="comment">// 获得 HttpHandler 类型对应的 Bean 的名字们</span></span><br><span class="line">    String[] beanNames = getBeanFactory().getBeanNamesForType(HttpHandler.class);</span><br><span class="line">    <span class="comment">// 如果是 0 个，抛出 ApplicationContextException 异常，因为至少要一个</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to missing HttpHandler bean."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 如果是 &gt; 1 个，抛出 ApplicationContextException 异常，因为不知道初始化哪个</span></span><br><span class="line">    <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start ReactiveWebApplicationContext due to multiple HttpHandler beans : "</span></span><br><span class="line">                        + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获得 HttpHandler 类型对应的 Bean 对象</span></span><br><span class="line">    <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], HttpHandler.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>默认情况下，返回的结果，如下图所示：<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-19/02.jpg" alt="示例"></li>
<li>该 HttpHandler Bean 对象，是在 <validateCode>org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration</validateCode> 配置类上，被初始化出来。</li>
</ul>
</li>
<li><p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>ServerManager#start(ServerManager manager, Supplier&lt;HttpHandler&gt; handlerSupplier)</validateCode> <strong>静态</strong>方法，启动 WebServer 。</p>
</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>ServerManager#getWebServer(serverManager)</validateCode> <strong>静态</strong>方法，获得 WebServer 对象。</li>
</ul>
<h2 id="5-6-onClose"><a href="#5-6-onClose" class="headerlink" title="5.6 onClose"></a>5.6 onClose</h2><p>覆写 <validateCode>#onClose()</validateCode> 方法，在 Spring 容器被关闭时，关闭 WebServer 。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ReactiveWebServerApplicationContext.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="comment">// 调用父类方法</span></span><br><span class="line">	<span class="keyword">super</span>.onClose();</span><br><span class="line">	<span class="comment">// 关闭 WebServer</span></span><br><span class="line">	stopAndReleaseReactiveWebServer();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="6-AnnotationConfigReactiveWebServerApplicationContext"><a href="#6-AnnotationConfigReactiveWebServerApplicationContext" class="headerlink" title="6. AnnotationConfigReactiveWebServerApplicationContext"></a>6. AnnotationConfigReactiveWebServerApplicationContext</h1><p><validateCode>org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext</validateCode> ，继承 ReactiveWebServerApplicationContext 类，实现 AnnotationConfigRegistry 接口，作用和 AnnotationConfigServletWebServerApplicationContext 相同，就不重复赘述了。</p>
<p>如果真要看的胖友，参考 <a href="http://svip.iocoder.cn/Spring-Boot/ServletWebServerApplicationContext/">《精尽 Spring Boot 源码分析 —— ServletWebServerApplicationContext》</a> 的 <a href="#">「3. AnnotationConfigServletWebServerApplicationContext」</a> 即可。</p>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>水更一篇，无可“狡辩”。嘻嘻。</p>




</div>