<div class="article-entry" itemprop="articleBody">

<h1>1. 概述</h1>
<p>本文我们来分享 <validateCode>@ConfigurationProperties</validateCode> 注解，如何将配置文件自动设置到被注解的类。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation for externalized configuration. Add this to a class definition or a</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@validateCode</span> <span class="doctag">@Bean</span>} method in a {<span class="doctag">@validateCode</span> <span class="doctag">@Configuration</span>} class if you want to bind and validate</span></span><br><span class="line"><span class="comment"> * some external Properties (e.g. from a .properties file).</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Note that contrary to {<span class="doctag">@validateCode</span> <span class="doctag">@Value</span>}, SpEL expressions are not evaluated since property</span></span><br><span class="line"><span class="comment"> * values are externalized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConfigurationPropertiesBindingPostProcessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableConfigurationProperties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConfigurationProperties {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to this object. Synonym</span></span><br><span class="line"><span class="comment">     * for {<span class="doctag">@link</span> #prefix()}. A valid prefix is defined by one or more words separated</span></span><br><span class="line"><span class="comment">     * with dots (e.g. {<span class="doctag">@validateCode</span> "acme.system.feature"}).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"prefix"</span>)</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to this object. Synonym</span></span><br><span class="line"><span class="comment">     * for {<span class="doctag">@link</span> #value()}. A valid prefix is defined by one or more words separated with</span></span><br><span class="line"><span class="comment">     * dots (e.g. {<span class="doctag">@validateCode</span> "acme.system.feature"}).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    <span class="function">String <span class="title">prefix</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flag to indicate that when binding to this object invalid fields should be ignored.</span></span><br><span class="line"><span class="comment">     * Invalid means invalid according to the binder that is used, and usually this means</span></span><br><span class="line"><span class="comment">     * fields of the wrong type (or that cannot be coerced into the correct type).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the flag value (default false)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">ignoreInvalidFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flag to indicate that when binding to this object unknown fields should be ignored.</span></span><br><span class="line"><span class="comment">     * An unknown field could be a sign of a mistake in the Properties.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the flag value (default true)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">ignoreUnknownFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><validateCode>@ConfigurationProperties</validateCode> 注解有两种使用方法，可见 <a href="https://www.jianshu.com/p/7f54da1cb2eb" rel="external nofollow noopener noreferrer" target="_blank">《关与 @EnableConfigurationProperties 注解》</a> 文章。总结来说：</p>
<ul>
<li>第一种，<validateCode>@Component</validateCode> + <validateCode>@ConfigurationProperties</validateCode> 。</li>
<li>第二种，<validateCode>@EnableConfigurationProperties</validateCode> + <validateCode>ConfigurationProperties</validateCode> 。</li>
</ul>
<p>实际情况下，更多的是使用第一种。当然，第二种的 <validateCode>@EnableConfigurationProperties</validateCode> 的效果，也是将指定的类，实现和 <validateCode>@Component</validateCode> 被注解的类是一样的，创建成 Bean 对象。<br>
这样，<validateCode>@ConfigurationProperties</validateCode> 就可以将配置文件自动设置到该 Bean 对象咧。</p>
<h1>2. @EnableConfigurationProperties</h1>
<p><validateCode>org.springframework.boot.context.properties.@EnableConfigurationProperties</validateCode> 注解，可以将指定带有 <validateCode>@ConfigurationProperties</validateCode> 的类，注册成 BeanDefinition ，从而创建成 Bean 对象。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationProperties.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Enable support for {<span class="doctag">@link</span> ConfigurationProperties} annotated beans.</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ConfigurationProperties} beans can be registered in the standard way (for</span></span><br><span class="line"><span class="comment"> * example using {<span class="doctag">@link</span> Bean <span class="doctag">@Bean</span>} methods) or, for convenience, can be specified</span></span><br><span class="line"><span class="comment"> * directly on this annotation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(EnableConfigurationPropertiesImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableConfigurationProperties {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定的类们</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">	 * Convenient way to quickly register {<span class="doctag">@link</span> ConfigurationProperties} annotated beans</span></span><br><span class="line"><span class="comment">	 * with Spring. Standard Spring Beans will also be scanned regardless of this value.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> {<span class="doctag">@link</span> ConfigurationProperties} annotated beans to register</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] value() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>从 <validateCode>@Import</validateCode> 注解上，可以看到使用 EnableConfigurationPropertiesImportSelector 处理。详细的解析，见 <a href="#">「2.2 EnableConfigurationPropertiesImportSelector」</a> 。</li>
</ul>
<h2>2.1 ConfigurationPropertiesAutoConfiguration</h2>
<p>默认情况下，<validateCode>@EnableConfigurationProperties</validateCode> 会通过 <validateCode>org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration</validateCode> 类，进行开启。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesAutoConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration} for {<span class="doctag">@link</span> ConfigurationProperties}</span></span><br><span class="line"><span class="comment"> * beans. Automatically binds and validates any bean annotated with</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@validateCode</span> <span class="doctag">@ConfigurationProperties</span>}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableConfigurationProperties</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConfigurationProperties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span> <span class="comment">// &lt;X&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationPropertiesAutoConfiguration</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>看，看看，看看看，<validateCode>&lt;X&gt;</validateCode> 哟~</li>
</ul>
<h2>2.2 EnableConfigurationPropertiesImportSelector</h2>
<p><validateCode>org.springframework.boot.context.properties.EnableConfigurationPropertiesImportSelector</validateCode> ，实现 ImportSelector 接口，处理 <validateCode>@EnableConfigurationProperties</validateCode> 注解。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] IMPORTS = {</span><br><span class="line">		ConfigurationPropertiesBeanRegistrar.class.getName(),</span><br><span class="line">		ConfigurationPropertiesBindingPostProcessorRegistrar.class.getName() };</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) {</span><br><span class="line">	<span class="keyword">return</span> IMPORTS;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>返回的 <validateCode>IMPORTS</validateCode> 的是两个 ImportBeanDefinitionRegistrar 实现类。分别是：
<ul>
<li>ConfigurationPropertiesBeanRegistrar ，在 <a href="#">「2.3 ConfigurationPropertiesBeanRegistrar」</a> 中详细解析。</li>
<li>ConfigurationPropertiesBindingPostProcessorRegistrar ，在 <a href="#">「2.4 ConfigurationPropertiesBindingPostProcessorRegistrar」</a> 中详细解析。</li>
</ul>
</li>
</ul>
<h2>2.3 ConfigurationPropertiesBeanRegistrar</h2>
<p>ConfigurationPropertiesBeanRegistrar ，是 EnableConfigurationPropertiesImportSelector 的内部静态类，实现 ImportBeanDefinitionRegistrar 接口，将 <validateCode>@EnableConfigurationProperties</validateCode> 注解指定的类，逐个注册成对应的 BeanDefinition 对象。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    getTypes(metadata) <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            .forEach((type) -&gt; register(registry, (ConfigurableListableBeanFactory) registry, type)); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getTypes(AnnotationMetadata metadata)</validateCode> 方法，获得 <validateCode>@EnableConfigurationProperties</validateCode> 注解指定的类的数组。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; getTypes(AnnotationMetadata metadata) {</span><br><span class="line">    <span class="comment">// 获得 @EnableConfigurationProperties 注解</span></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; attributes = metadata.getAllAnnotationAttributes(EnableConfigurationProperties.class.getName(), <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 获得 value 属性</span></span><br><span class="line">    <span class="keyword">return</span> collectClasses((attributes != <span class="keyword">null</span>) ? attributes.get(<span class="string">"value"</span>)</span><br><span class="line">            : Collections.emptyList());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; collectClasses(List&lt;?&gt; values) {</span><br><span class="line">    <span class="keyword">return</span> values.stream().flatMap((value) -&gt; Arrays.stream((Object[]) value))</span><br><span class="line">            .map((o) -&gt; (Class&lt;?&gt;) o).filter((type) -&gt; <span class="keyword">void</span>.class != type)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>~</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，遍历，逐个调用 <validateCode>#register(BeanDefinitionRegistry registry, ConfigurableListableBeanFactory beanFactory, Class&lt;?&gt; type)</validateCode> 方法，注册每个类对应的 BeanDefinition 对象。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(BeanDefinitionRegistry registry, ConfigurableListableBeanFactory beanFactory, Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;2.1&gt; 通过 @ConfigurationProperties 注解，获得最后要生成的 BeanDefinition 的名字。格式为 prefix-类全名 or 类全名</span></span><br><span class="line">    String name = getName(type);</span><br><span class="line">    <span class="comment">// &lt;2.2&gt; 判断是否已经有该名字的 BeanDefinition 的名字。没有，才进行注册</span></span><br><span class="line">    <span class="keyword">if</span> (!containsBeanDefinition(beanFactory, name)) {</span><br><span class="line">        registerBeanDefinition(registry, name, type); <span class="comment">// &lt;2.3&gt; </span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;2.1&gt;</validateCode> 处，调用  <validateCode>#getName(Class&lt;?&gt; type)</validateCode> 方法，通过 <validateCode>@ConfigurationProperties</validateCode> 注解，获得最后要生成的 BeanDefinition 的名字。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getName</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    ConfigurationProperties annotation = AnnotationUtils.findAnnotation(type, ConfigurationProperties.class);</span><br><span class="line">    String prefix = (annotation != <span class="keyword">null</span>) ? annotation.prefix() : <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">return</span> (StringUtils.hasText(prefix) ? prefix + <span class="string">"-"</span> + type.getName() : type.getName());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>格式为 <validateCode>prefix-</validateCode>类全名 or 类全名。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2.2&gt;</validateCode> 处，调用 <validateCode>#containsBeanDefinition(ConfigurableListableBeanFactory beanFactory, String name)</validateCode> 方法，判断是否已经有该名字的 BeanDefinition 的名字。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(ConfigurableListableBeanFactory beanFactory, String name)</span> </span>{</span><br><span class="line">    <span class="comment">// 判断是否存在 BeanDefinition 。如果有，则返回 true</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBeanDefinition(name)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获得父容器，判断是否存在</span></span><br><span class="line">    BeanFactory parent = beanFactory.getParentBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) {</span><br><span class="line">        <span class="keyword">return</span> containsBeanDefinition((ConfigurableListableBeanFactory) parent, name);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 返回 false ，说明不存在</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>如果不存在，才执行后续的注册 BeanDefinition 逻辑。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2.3&gt;</validateCode> 处，调用 <validateCode>#registerBeanDefinition(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; type)</validateCode> 方法，注册 BeanDefinition 。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// EnableConfigurationPropertiesImportSelector#ConfigurationPropertiesBeanRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// 断言，判断该类有 @ConfigurationProperties 注解</span></span><br><span class="line">    assertHasAnnotation(type);</span><br><span class="line">    <span class="comment">// 创建 GenericBeanDefinition 对象</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(type);</span><br><span class="line">    <span class="comment">// 注册到 BeanDefinitionRegistry 中</span></span><br><span class="line">    registry.registerBeanDefinition(name, definition);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assertHasAnnotation</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">    Assert.notNull(</span><br><span class="line">            AnnotationUtils.findAnnotation(type, ConfigurationProperties.class),</span><br><span class="line">            () -&gt; <span class="string">"No "</span> + ConfigurationProperties.class.getSimpleName()</span><br><span class="line">                    + <span class="string">" annotation found on  '"</span> + type.getName() + <span class="string">"'."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>~</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>2.4 ConfigurationPropertiesBindingPostProcessorRegistrar</h2>
<p><validateCode>org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessorRegistrar</validateCode> ，实现 ImportBeanDefinitionRegistrar 接口，代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(ConfigurationPropertiesBindingPostProcessor.BEAN_NAME)) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; 注册 ConfigurationPropertiesBindingPostProcessor BeanDefinition</span></span><br><span class="line">        registerConfigurationPropertiesBindingPostProcessor(registry);</span><br><span class="line">        <span class="comment">// &lt;2&gt; 注册 ConfigurationBeanFactoryMetadata BeanDefinition</span></span><br><span class="line">        registerConfigurationBeanFactoryMetadata(registry);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#registerConfigurationPropertiesBindingPostProcessor(BeanDefinitionRegistry registry)</validateCode> 方法，注册 ConfigurationPropertiesBindingPostProcessor BeanDefinition 。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationPropertiesBindingPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建 GenericBeanDefinition 对象</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(ConfigurationPropertiesBindingPostProcessor.class);</span><br><span class="line">    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    registry.registerBeanDefinition(ConfigurationPropertiesBindingPostProcessor.BEAN_NAME, definition);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>关于 ConfigurationPropertiesBindingPostProcessor 类，我们在 <a href="#">「4. ConfigurationPropertiesBindingPostProcessor 相关」</a> 中，详细解析。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#registerConfigurationBeanFactoryMetadata(BeanDefinitionRegistry registry)</validateCode> 方法，注册 ConfigurationBeanFactoryMetadata BeanDefinition 。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessorRegistrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationBeanFactoryMetadata</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建 GenericBeanDefinition 对象</span></span><br><span class="line">    GenericBeanDefinition definition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    definition.setBeanClass(ConfigurationBeanFactoryMetadata.class);</span><br><span class="line">    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    registry.registerBeanDefinition(ConfigurationBeanFactoryMetadata.BEAN_NAME, definition);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>关于 ConfigurationBeanFactoryMetadata 类，我们在 <a href="#">「3. ConfigurationBeanFactoryMetadata」</a> 中，详细解析。</li>
</ul>
</li>
</ul>
<h1>3. ConfigurationBeanFactoryMetadata</h1>
<p><validateCode>org.springframework.boot.context.properties.ConfigurationBeanFactoryMetadata</validateCode> ，初始化配置类创建 Bean 的每个方法的元数据。</p>
<h2>3.1 postProcessBeanFactory</h2>
<p>实现 <validateCode>#postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</validateCode> 方法，代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FactoryMetadata 的映射</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEY ：Bean 的名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FactoryMetadata&gt; beansFactoryMetadata = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 初始化 beanFactory 属性</span></span><br><span class="line">    <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    <span class="comment">// &lt;2&gt; 遍历所有的 BeanDefinition 的名字们</span></span><br><span class="line">    <span class="keyword">for</span> (String name : beanFactory.getBeanDefinitionNames()) {</span><br><span class="line">        <span class="comment">// &lt;2.1&gt; 获得 BeanDefinition 对象</span></span><br><span class="line">        BeanDefinition definition = beanFactory.getBeanDefinition(name);</span><br><span class="line">        <span class="comment">// &lt;2.2&gt; 获得 method、bean 属性</span></span><br><span class="line">        String method = definition.getFactoryMethodName();</span><br><span class="line">        String bean = definition.getFactoryBeanName();</span><br><span class="line">        <span class="comment">// &lt;2.3&gt; 添加到 beansFactoryMetadata 中</span></span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">this</span>.beansFactoryMetadata.put(name, <span class="keyword">new</span> FactoryMetadata(bean, method));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;1&gt;</validateCode> 处，初始化 <validateCode>beanFactory</validateCode> 属性。</p>
</li>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，遍历所有的 BeanDefinition 的名字们，初始化 <validateCode>beansFactoryMetadata</validateCode> 属性。</p>
</li>
<li>
<p><validateCode>&lt;2.1&gt;</validateCode> 处，获得 BeanDefinition 对象。</p>
</li>
<li>
<p><validateCode>&lt;2.2&gt;</validateCode> 处，获得 BeanDefinition 的 <validateCode>factoryMethodName</validateCode>、<validateCode>factoryBeanName</validateCode> 属性。</p>
<ul>
<li>
<p><validateCode>factoryBeanName</validateCode> 属性，是创建该 Bean 的工厂 Bean 的名字。</p>
</li>
<li>
<p><validateCode>factoryMethodName</validateCode> 属性，是创建 Bean 的工厂 Bean 的方法名。</p>
</li>
<li>
<p>以如下的 Configuration 类，举个例子：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">testObject</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Object();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>每个 <validateCode>@Bean</validateCode> 注解的方法，都是一个 <validateCode>factoryBeanName</validateCode> + <validateCode>factoryMethodName</validateCode> 。</li>
<li><validateCode>factoryBeanName</validateCode> 属性，为 <validateCode>"testConfiguration"</validateCode> 。</li>
<li><validateCode>factoryMethodName</validateCode> 属性，为 <validateCode>"testObject"</validateCode> 。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2.3&gt;</validateCode> 处，都非空的情况下，添加到 <validateCode>beansFactoryMetadata</validateCode> 中。</p>
</li>
<li>
<p>FactoryMetadata 是 ConfigurationBeanFactoryMetadata 的内部静态类。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata#FactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryMetadata</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean 的名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bean;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bean 的方法名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 省略 setting / getting  方法</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ul>
<h2>3.2 findFactoryMethod</h2>
<p><validateCode>#findFactoryMethod(String beanName)</validateCode> 方法，获得指定 Bean 的创建方法。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">findFactoryMethod</span><span class="params">(String beanName)</span> </span>{</span><br><span class="line">    <span class="comment">// 如果不存在，则返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.beansFactoryMetadata.containsKey(beanName)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    AtomicReference&lt;Method&gt; found = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 获得 beanName 对应的 FactoryMetadata 对象</span></span><br><span class="line">    FactoryMetadata metadata = <span class="keyword">this</span>.beansFactoryMetadata.get(beanName);</span><br><span class="line">    <span class="comment">// 获得对应的工厂类</span></span><br><span class="line">    Class&lt;?&gt; factoryType = <span class="keyword">this</span>.beanFactory.getType(metadata.getBean());</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isCglibProxyClass(factoryType)) {</span><br><span class="line">        factoryType = factoryType.getSuperclass();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获得对应的工厂类的方法</span></span><br><span class="line">    String factoryMethod = metadata.getMethod();</span><br><span class="line">    ReflectionUtils.doWithMethods(factoryType, (method) -&gt; {</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(factoryMethod)) {</span><br><span class="line">            found.compareAndSet(<span class="keyword">null</span>, method);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> found.get();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2>3.3 findFactoryAnnotation</h2>
<p><validateCode>#findFactoryAnnotation(String beanName, Class&lt;A&gt; type)</validateCode> 方法，获得指定 Bean 的创建方法上的注解。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">findFactoryAnnotation</span><span class="params">(String beanName, Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得方法</span></span><br><span class="line">    Method method = findFactoryMethod(beanName);</span><br><span class="line">    <span class="comment">// 获得注解</span></span><br><span class="line">    <span class="keyword">return</span> (method != <span class="keyword">null</span>) ? AnnotationUtils.findAnnotation(method, type) : <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2>3.4 getBeansWithFactoryAnnotation</h2>
<p><validateCode>#getBeansWithFactoryAnnotation(Class&lt;A&gt; type)</validateCode> 方法，获得 <validateCode>beansFactoryMetadata</validateCode> 中的每个 Bean 的方法上的指定注解。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationBeanFactoryMetadata.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">Map&lt;String, Object&gt; <span class="title">getBeansWithFactoryAnnotation</span><span class="params">(Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 遍历 beansFactoryMetadata</span></span><br><span class="line">    <span class="keyword">for</span> (String name : <span class="keyword">this</span>.beansFactoryMetadata.keySet()) {</span><br><span class="line">        <span class="comment">// 获得每个 Bean 的创建方法上的注解</span></span><br><span class="line">        <span class="keyword">if</span> (findFactoryAnnotation(name, type) != <span class="keyword">null</span>) {</span><br><span class="line">            result.put(name, <span class="keyword">this</span>.beanFactory.getBean(name));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>😈 至此，我们基本能够明白，ConfigurationBeanFactoryMetadata 就是提供一些元数据的。</p>
<h1>4. ConfigurationPropertiesBindingPostProcessor 相关</h1>
<blockquote>
<p>艿艿：因为 ConfigurationPropertiesBindingPostProcessor 涉及到好几个类，所以一起放在本小节来看看。</p>
</blockquote>
<h2>4.1 ConfigurationPropertiesBindingPostProcessor</h2>
<p><validateCode>org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor</validateCode> ，实现 BeanPostProcessor、PriorityOrdered、ApplicationContextAware、InitializingBean 接口，将配置文件注入到 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性中。</p>
<h3>4.1.1 基本属性</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The bean name of the configuration properties validator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALIDATOR_BEAN_NAME = <span class="string">"configurationPropertiesValidator"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurationBeanFactoryMetadata beanFactoryMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurationPropertiesBinder configurationPropertiesBinder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="keyword">this</span>.applicationContext = applicationContext; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// We can't use constructor injection of the application context because</span></span><br><span class="line">    <span class="comment">// it causes eager factory bean initialization</span></span><br><span class="line">    <span class="keyword">this</span>.beanFactoryMetadata = <span class="keyword">this</span>.applicationContext.getBean(ConfigurationBeanFactoryMetadata.BEAN_NAME, ConfigurationBeanFactoryMetadata.class); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.configurationPropertiesBinder = <span class="keyword">new</span> ConfigurationPropertiesBinder(<span class="keyword">this</span>.applicationContext, VALIDATOR_BEAN_NAME); <span class="comment">// &lt;3&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，设置 <validateCode>applicationContext</validateCode> 属性。</li>
<li><validateCode>&lt;2&gt;</validateCode> 处，设置 <validateCode>beanFactoryMetadata</validateCode> 属性。即，我们在 <a href="#">「3. ConfigurationBeanFactoryMetadata」</a> 中看到的。</li>
<li><validateCode>&lt;3&gt;</validateCode> 处，创建 ConfigurationPropertiesBinder 对象，设置到 <validateCode>configurationPropertiesBinder</validateCode> 属性。TODO  ConfigurationPropertiesBinder</li>
</ul>
<h3>4.1.2 postProcessBeforeInitialization</h3>
<p>实现 <validateCode>#postProcessBeforeInitialization(Object bean, String beanName)</validateCode> 方法，代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得 Bean 上的 @ConfigurationProperties 属性</span></span><br><span class="line">    ConfigurationProperties annotation = getAnnotation(bean, beanName, ConfigurationProperties.class);</span><br><span class="line">    <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// &lt;2&gt; 将配置文件注入到 `@ConfigurationProperties` 注解的 Bean 的属性中</span></span><br><span class="line">        bind(bean, beanName, annotation);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><validateCode>&lt;1&gt;</validateCode> 处，调用 <validateCode>#getAnnotation(Object bean, String beanName, Class&lt;A&gt; type)</validateCode> 方法，获得 Bean 上的 <validateCode>@ConfigurationProperties</validateCode> 属性。代码如下：
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Object bean, String beanName, Class&lt;A&gt; type)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得 Bean 上的注解</span></span><br><span class="line">    A annotation = <span class="keyword">this</span>.beanFactoryMetadata.findFactoryAnnotation(beanName, type);</span><br><span class="line">    <span class="comment">// 如果获得不到，则获得 Bean 对应的 Class 上的注解</span></span><br><span class="line">    <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) {</span><br><span class="line">        annotation = AnnotationUtils.findAnnotation(bean.getClass(), type);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> annotation;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<ul>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#bind(Object bean, String beanName, ConfigurationProperties annotation)</validateCode> 方法，将配置文件注入到 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性中。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object bean, String beanName, ConfigurationProperties annotation)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;2.1&gt; 解析 Bean 的类型</span></span><br><span class="line">    ResolvableType type = getBeanType(bean, beanName);</span><br><span class="line">    <span class="comment">// &lt;2.2&gt; 获得 Bean 上的 @Validated 注解</span></span><br><span class="line">    Validated validated = getAnnotation(bean, beanName, Validated.class);</span><br><span class="line">    <span class="comment">// &lt;2.3&gt; 创建 Annotation 数组</span></span><br><span class="line">    Annotation[] annotations = (validated != <span class="keyword">null</span>)</span><br><span class="line">            ? <span class="keyword">new</span> Annotation[] { annotation, validated }</span><br><span class="line">            : <span class="keyword">new</span> Annotation[] { annotation };</span><br><span class="line">    <span class="comment">// &lt;2.4&gt; 创建 Bindable 对象</span></span><br><span class="line">    Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(bean).withAnnotations(annotations);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;2.5&gt; 将配置文件注入到 `@ConfigurationProperties` 注解的 Bean 的属性中</span></span><br><span class="line">        <span class="keyword">this</span>.configurationPropertiesBinder.bind(target);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationPropertiesBindException(beanName, bean, annotation, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;2.1&gt;</validateCode> 处，调用 <validateCode>#getBeanType(Object bean, String beanName)</validateCode> 方法，解析 Bean 的类型。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBindingPostProcessor.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResolvableType <span class="title">getBeanType</span><span class="params">(Object bean, String beanName)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得 beanName 对应的工厂方法</span></span><br><span class="line">    Method factoryMethod = <span class="keyword">this</span>.beanFactoryMetadata.findFactoryMethod(beanName);</span><br><span class="line">    <span class="comment">// 情况一：如果是，说明是 Configuration 类创建的 Bean 对象</span></span><br><span class="line">    <span class="keyword">if</span> (factoryMethod != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> ResolvableType.forMethodReturnType(factoryMethod);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 情况二：如果否，说明是普通的类创建的 Bean 对象</span></span><br><span class="line">    <span class="keyword">return</span> ResolvableType.forClass(bean.getClass());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>两种情况，见注释。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;2.2&gt;</validateCode> 处，调用 <validateCode>#getAnnotation(Object bean, String beanName, Class&lt;A&gt; type)</validateCode> 方法，获得 Bean 上的 <validateCode>@Validated</validateCode> 属性。<validateCode>@ConfigurationProperties</validateCode> 注解，可以配合 <validateCode>@Validated</validateCode> 注解，一起使用，从而实现校验的功能。具体可以看看 <a href="https://github.com/spring-projects/spring-boot/issues/10803" rel="external nofollow noopener noreferrer" target="_blank">《Enable <validateCode>ConfigurationProperties</validateCode> validation with <validateCode>@Validated</validateCode> on the factory method》</a> 文章。</p>
</li>
<li>
<p><validateCode>&lt;2.3&gt;</validateCode> 处，创建 Annotation 数组。</p>
</li>
<li>
<p><validateCode>&lt;2.4&gt;</validateCode> 处，创建 Bindable 对象。我们先不用去理解 Bindable 是个锤子，至少我们看到了 <validateCode>withExistingValue(bean)</validateCode> 设置了 Bean 对象，<validateCode>withAnnotations(annotations)</validateCode> 设置了 Annotation 注解数组。</p>
</li>
<li>
<p><validateCode>&lt;2.5&gt;</validateCode> 处，调用 <validateCode>ConfigurationPropertiesBinder#bind(Bindable&lt;?&gt; target)</validateCode> 方法，将配置文件注入到 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性中。详细解析，见 <a href="#">「4.2 ConfigurationPropertiesBinder」</a> 。</p>
</li>
</ul>
</li>
</ul>
<h2>4.2 ConfigurationPropertiesBinder</h2>
<p><validateCode>org.springframework.boot.context.properties.ConfigurationPropertiesBinder</validateCode> ，处理 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性的注入。其类上的注释如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal class by the {<span class="doctag">@link</span> ConfigurationPropertiesBindingPostProcessor} to handle the</span></span><br><span class="line"><span class="comment"> * actual {<span class="doctag">@link</span> ConfigurationProperties} binding.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.2.1 构造方法</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PropertySources propertySources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Validator configurationPropertiesValidator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jsr303Present;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Validator jsr303Validator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Binder binder;</span><br><span class="line"></span><br><span class="line">ConfigurationPropertiesBinder(ApplicationContext applicationContext, String validatorBeanName) {</span><br><span class="line">	<span class="keyword">this</span>.applicationContext = applicationContext; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	<span class="keyword">this</span>.propertySources = <span class="keyword">new</span> PropertySourcesDeducer(applicationContext).getPropertySources(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">	<span class="keyword">this</span>.configurationPropertiesValidator = getConfigurationPropertiesValidator(applicationContext, validatorBeanName); <span class="comment">// &lt;3&gt; </span></span><br><span class="line">	<span class="keyword">this</span>.jsr303Present = ConfigurationPropertiesJsr303Validator.isJsr303Present(applicationContext); <span class="comment">// &lt;4&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;1&gt;</validateCode> 处，设置 <validateCode>applicationContext</validateCode> 属性。</p>
</li>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，创建 <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/PropertySourcesDeducer.java" rel="external nofollow noopener noreferrer" target="_blank"><validateCode>org.springframework.boot.context.properties.PropertySourcesDeducer</validateCode></a> 对象，然后调用 <validateCode>PropertySourcesDeducer#getPropertySources()</validateCode> 方法，获得 PropertySource 数组，之后设置给 <validateCode>propertySources</validateCode> 属性。关于 PropertySourcesDeducer.java 类，胖友点击链接，自己看看即可。</p>
</li>
<li>
<p><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#getConfigurationPropertiesValidator(ApplicationContext applicationContext, String validatorBeanName)</validateCode> 方法，获得配置的 Validator 对象。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Validator <span class="title">getConfigurationPropertiesValidator</span><span class="params">(ApplicationContext applicationContext, String validatorBeanName)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (applicationContext.containsBean(validatorBeanName)) {</span><br><span class="line">		<span class="keyword">return</span> applicationContext.getBean(validatorBeanName, Validator.class);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>从上面的文章，可以知道 <validateCode>validatorBeanName</validateCode> 为 <validateCode>"configurationPropertiesValidator"</validateCode> 。即，创建的 Validator Bean 的对象。</li>
<li>一般情况下，我们不会配置该 Bean 对象，所以返回 <validateCode>null</validateCode> 。因此吧，可以暂时无视这个 <validateCode>configurationPropertiesValidator</validateCode> 属性~。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>ConfigurationPropertiesJsr303Validator#isJsr303Present(ApplicationContext applicationContext)</validateCode> 方法，是否有引入 Jsr 303 Validator 相关的依赖。关于它，详细解析见 <a href="#">「4.3 ConfigurationPropertiesJsr303Validator」</a> 中。</p>
</li>
</ul>
<h3>4.2.2 bind</h3>
<p><validateCode>#bind(Bindable&lt;?&gt; target)</validateCode> 方法，处理 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性的注入。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Bindable&lt;?&gt; target)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; 获得 @ConfigurationProperties 注解的属性</span></span><br><span class="line">    ConfigurationProperties annotation = target.getAnnotation(ConfigurationProperties.class);</span><br><span class="line">    Assert.state(annotation != <span class="keyword">null</span>, () -&gt; <span class="string">"Missing @ConfigurationProperties on "</span> + target);</span><br><span class="line">    <span class="comment">// &lt;2&gt; 获得 Validator 数组</span></span><br><span class="line">    List&lt;Validator&gt; validators = getValidators(target);</span><br><span class="line">    <span class="comment">// &lt;3&gt; 获得 BindHandler 对象</span></span><br><span class="line">    BindHandler bindHandler = getBindHandler(annotation, validators);</span><br><span class="line">    <span class="comment">// &lt;4&gt; 获得 Binder 对象，然后执行绑定逻辑，处理 `@ConfigurationProperties` 注解的 Bean 的属性的注入</span></span><br><span class="line">    getBinder().bind(annotation.prefix(), target, bindHandler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>
<p><validateCode>&lt;1&gt;</validateCode> 处，获得 <validateCode>@ConfigurationProperties</validateCode> 注解的属性。</p>
</li>
<li>
<p><validateCode>&lt;2&gt;</validateCode> 处，调用 <validateCode>#getValidators(Bindable&lt;?&gt; target)</validateCode> 方法，获得 Validator 数组。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Validator&gt; <span class="title">getValidators</span><span class="params">(Bindable&lt;?&gt; target)</span> </span>{</span><br><span class="line">    List&lt;Validator&gt; validators = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 来源一，configurationPropertiesValidator</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.configurationPropertiesValidator != <span class="keyword">null</span>) {</span><br><span class="line">        validators.add(<span class="keyword">this</span>.configurationPropertiesValidator);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 来源二，ConfigurationPropertiesJsr303Validator 对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jsr303Present &amp;&amp; target.getAnnotation(Validated.class) != <span class="keyword">null</span>) {</span><br><span class="line">        validators.add(getJsr303Validator());</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 来源三，自己实现了 Validator 接口</span></span><br><span class="line">    <span class="keyword">if</span> (target.getValue() != <span class="keyword">null</span> &amp;&amp; target.getValue().get() <span class="keyword">instanceof</span> Validator) {</span><br><span class="line">        validators.add((Validator) target.getValue().get());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> validators;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回 ConfigurationPropertiesJsr303Validator 对象</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Validator <span class="title">getJsr303Validator</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jsr303Validator == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">this</span>.jsr303Validator = <span class="keyword">new</span> ConfigurationPropertiesJsr303Validator(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jsr303Validator;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>三个来源。</li>
</ul>
</li>
<li>
<p><validateCode>&lt;3&gt;</validateCode> 处，调用 <validateCode>#getBindHandler(ConfigurationProperties annotation, List&lt;Validator&gt; validators)</validateCode> 方法，获得 BindHandler 对象。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> BindHandler <span class="title">getBindHandler</span><span class="params">(ConfigurationProperties annotation, List&lt;Validator&gt; validators)</span> </span>{</span><br><span class="line">	BindHandler handler = <span class="keyword">new</span> IgnoreTopLevelConverterNotFoundBindHandler();</span><br><span class="line">	<span class="comment">// 如果有 ignoreInvalidFields 属性，进一步包装成 IgnoreErrorsBindHandler 类</span></span><br><span class="line">	<span class="keyword">if</span> (annotation.ignoreInvalidFields()) {</span><br><span class="line">		handler = <span class="keyword">new</span> IgnoreErrorsBindHandler(handler);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 如果否 ignoreUnknownFields 属性，进一步包装成 NoUnboundElementsBindHandler 类</span></span><br><span class="line">	<span class="keyword">if</span> (!annotation.ignoreUnknownFields()) {</span><br><span class="line">		UnboundElementsSourceFilter filter = <span class="keyword">new</span> UnboundElementsSourceFilter();</span><br><span class="line">		handler = <span class="keyword">new</span> NoUnboundElementsBindHandler(handler, filter);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;X&gt; 如果 Validator 数组非空，进一步包装成 ValidationBindHandler 对象</span></span><br><span class="line">	<span class="keyword">if</span> (!validators.isEmpty()) {</span><br><span class="line">		handler = <span class="keyword">new</span> ValidationBindHandler(handler, validators.toArray(<span class="keyword">new</span> Validator[<span class="number">0</span>]));</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// &lt;Y&gt; 如果有 ConfigurationPropertiesBindHandlerAdvisor 元素，则进一步处理 handler 对象</span></span><br><span class="line">	<span class="keyword">for</span> (ConfigurationPropertiesBindHandlerAdvisor advisor : getBindHandlerAdvisors()) {</span><br><span class="line">		handler = advisor.apply(handler);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> handler;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ConfigurationPropertiesBindHandlerAdvisor&gt; <span class="title">getBindHandlerAdvisors</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.applicationContext.getBeanProvider(ConfigurationPropertiesBindHandlerAdvisor.class)</span><br><span class="line">			.orderedStream().collect(Collectors.toList());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，通过将 <validateCode>handler</validateCode> 包装成 ValidationBindHandler 对象，从而实现 Validator 功能的提供。</li>
<li><validateCode>&lt;Y&gt;</validateCode> 处，此处的 <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/ConfigurationPropertiesBindHandlerAdvisor.java" rel="external nofollow noopener noreferrer" target="_blank"><validateCode>org.springframework.boot.context.properties.ConfigurationPropertiesBindHandlerAdvisor</validateCode></a> 接口，通过实现它，并注册到 Spring 容器中，可以对 <validateCode>handler</validateCode> 进一步处理。😈 当然，大多数情况下，包括 Spring Boot 也并未提供其实现，我们不需要这么做。所以呢，这块我们又可以无视落。</li>
<li>🙂 另外，关于 BindHandler 是什么，我们先不用去研究。后续，我们放在另外的文章，来慢慢讲解~</li>
</ul>
</li>
<li>
<p><validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>#getBinder()</validateCode> 方法，获得 Binder 对象。代码如下：
</p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesBinder.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Binder <span class="title">getBinder</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.binder == <span class="keyword">null</span>) {</span><br><span class="line">	    <span class="comment">// 创建 Binder 对象</span></span><br><span class="line">		<span class="keyword">this</span>.binder = <span class="keyword">new</span> Binder(getConfigurationPropertySources(),</span><br><span class="line">				getPropertySourcesPlaceholdersResolver(),</span><br><span class="line">                getConversionService(),</span><br><span class="line">				getPropertyEditorInitializer());</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.binder;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Iterable&lt;ConfigurationPropertySource&gt; <span class="title">getConfigurationPropertySources</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> ConfigurationPropertySources.from(<span class="keyword">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PropertySourcesPlaceholdersResolver <span class="title">getPropertySourcesPlaceholdersResolver</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PropertySourcesPlaceholdersResolver(<span class="keyword">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ConversionService <span class="title">getConversionService</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ConversionServiceDeducer(<span class="keyword">this</span>.applicationContext).getConversionService(); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Consumer&lt;PropertyEditorRegistry&gt; <span class="title">getPropertyEditorInitializer</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.applicationContext <span class="keyword">instanceof</span> ConfigurableApplicationContext) {</span><br><span class="line">		<span class="keyword">return</span> ((ConfigurableApplicationContext) <span class="keyword">this</span>.applicationContext).getBeanFactory()::copyRegisteredEditorsTo;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><validateCode>&lt;X&gt;</validateCode> 处，创建 ConversionServiceDeducer 创建，然后调用 <validateCode>ConversionServiceDeducer#getConversionService()</validateCode> 方法，获得 ConversionService 对象。ConversionService 是 Spring 中，用来作为类型转换器的。关于 <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/context/properties/ConversionServiceDeducer.java" rel="external nofollow noopener noreferrer" target="_blank"><validateCode>org.springframework.boot.context.properties.ConversionServiceDeducer</validateCode></a> 类，胖友点击链接，简单看看即可。当然，也可以不看~</li>
</ul>
</li>
<li>
<p><validateCode>&lt;4&gt;</validateCode> 处，调用 <validateCode>Binder#bind(String name, Bindable&lt;T&gt; target, BindHandler handler)</validateCode> 方法，执行绑定逻辑，处理 <validateCode>@ConfigurationProperties</validateCode> 注解的 Bean 的属性的注入。😈 至此，撒花~</p>
</li>
</ul>
<h2>4.3 ConfigurationPropertiesJsr303Validator</h2>
<p><validateCode>org.springframework.boot.context.properties.ConfigurationPropertiesJsr303Validator</validateCode> ，实现 Validator 接口，<validateCode>@ConfigurationProperties</validateCode> + <validateCode>@Validated</validateCode> 注解的 Bean 的 JSR303 的 Validator 实现类。其类上的注释如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Validator that supports configuration classes annotated with</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> Validated <span class="doctag">@Validated</span>}.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.1 构造方法</h3>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Delegate delegate;</span><br><span class="line"></span><br><span class="line">ConfigurationPropertiesJsr303Validator(ApplicationContext applicationContext) {</span><br><span class="line">	<span class="keyword">this</span>.delegate = <span class="keyword">new</span> Delegate(applicationContext);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Delegate</span> <span class="keyword">extends</span> <span class="title">LocalValidatorFactoryBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    Delegate(ApplicationContext applicationContext) {</span><br><span class="line">        <span class="comment">// 设置 applicationContext 属性</span></span><br><span class="line">        setApplicationContext(applicationContext);</span><br><span class="line">        <span class="comment">// 设置 messageInterpolator 属性</span></span><br><span class="line">        setMessageInterpolator(<span class="keyword">new</span> MessageInterpolatorFactory().getObject());</span><br><span class="line">        <span class="comment">// 回调 afterPropertiesSet 方法</span></span><br><span class="line">        afterPropertiesSet();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.2 isJsr303Present</h3>
<p><validateCode>#isJsr303Present(ApplicationContext applicationContext)</validateCode> 方法，校验是否支持 JSR303 。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] VALIDATOR_CLASSES = { <span class="string">"javax.validation.Validator"</span>,</span><br><span class="line">		<span class="string">"javax.validation.ValidatorFactory"</span>,</span><br><span class="line">		<span class="string">"javax.validation.bootstrap.GenericBootstrap"</span> };</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJsr303Present</span><span class="params">(ApplicationContext applicationContext)</span> </span>{</span><br><span class="line">	ClassLoader classLoader = applicationContext.getClassLoader();</span><br><span class="line">	<span class="keyword">for</span> (String validatorClass : VALIDATOR_CLASSES) {</span><br><span class="line">		<span class="keyword">if</span> (!ClassUtils.isPresent(validatorClass, classLoader)) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>通过判断，是否引入了相关的依赖。</li>
</ul>
<h3>4.3.3 supports</h3>
<p>实现 <validateCode>#supports(Class&lt;?&gt; type)</validateCode> 方法，判断是否支持指定类的校验。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.delegate.supports(type);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3>4.3.4 validate</h3>
<p>实现 <validateCode>#validate(Object target, Errors errors)</validateCode> 方法，执行校验。代码如下：</p>
<p></p><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// ConfigurationPropertiesJsr303Validator.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object target, Errors errors)</span> </span>{</span><br><span class="line">	<span class="keyword">this</span>.delegate.validate(target, errors);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1>666. 彩蛋</h1>
<p>呼呼，终于写了一篇相对短一点的文章，舒服~关于本文看到的 Binder、BinderHandler、Bindable 等等类，属于 <validateCode>org.springframework.boot.context.properties.bind</validateCode> 包，后续我们根据需要，会对这块在进行详细的解析~</p>
<p>参考和推荐如下文章：</p>
<ul>
<li>oldflame-Jm <a href="https://blog.csdn.net/jamet/article/details/78505703" rel="external nofollow noopener noreferrer" target="_blank">《Spring boot源码分析-ConfigurationProperties》</a></li>
<li>梦想2018 <a href="https://blog.csdn.net/ab411919134/article/details/81190425" rel="external nofollow noopener noreferrer" target="_blank">《spring @EnableConfigurationProperties 实现原理》</a></li>
<li>一个努力的码农
<ul>
<li><a href="https://blog.csdn.net/qq_26000415/article/details/78942494" rel="external nofollow noopener noreferrer" target="_blank">《spring boot 源码解析13-@ConfigurationProperties是如何生效的》</a></li>
<li><a href="https://blog.csdn.net/qq_26000415/article/details/78947283" rel="external nofollow noopener noreferrer" target="_blank">《spring boot 源码解析14-默认错误页面处理流程, 自定义,及EnableAutoConfigurationImportSelector处理》</a></li>
</ul>
</li>
</ul>




</div>