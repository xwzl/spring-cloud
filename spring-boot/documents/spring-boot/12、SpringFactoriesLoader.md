<div class="article-entry" itemprop="articleBody">

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文，我们来补充 <a href="http://svip.iocoder.cn/Spring-Boot/SpringApplication">《精尽 Spring Boot 源码分析 —— SpringApplication》</a> 文章，并未详细解析的 SpringFactoriesLoader 。</p>
<ul>
<li><p><validateCode>spring.factories</validateCode> 配置文件，我们可以认为是 Spring 自己的一套 SPI 机制的配置文件，在里面可以配置不同接口对应的实现类<strong>们</strong>。例如：</p>
<figure class="highlight plain"><table><tbody><tr><td class="validateCode"><pre><span class="line"># PropertySource Loaders</span><br><span class="line">org.springframework.boot.env.PropertySourceLoader=\</span><br><span class="line">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span><br><span class="line">org.springframework.boot.env.YamlPropertySourceLoader</span><br><span class="line"></span><br><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br><span class="line"></span><br><span class="line">// ... 省略其它</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>并且，Spring 内置了多个 <validateCode>spring.factories</validateCode> 配置文件。另外，我们也可以添加 <validateCode>spring.factories</validateCode> 配置文件。</li>
</ul>
</li>
<li><p>SpringFactoriesLoader 类，用于加载 <validateCode>spring.factories</validateCode> 配置文件。</p>
</li>
</ul>
<blockquote>
<p>艿艿：如果对 Java SPI 不了解的胖友，推荐后面看看 <a href="http://www.iocoder.cn/Fight/xuma/spi/?vip" rel="external nofollow noopener noreferrer" target="_blank">《JAVA 拾遗 —— 关于 SPI 机制》</a> 文章。</p>
</blockquote>
<h1 id="2-SpringFactoriesLoader"><a href="#2-SpringFactoriesLoader" class="headerlink" title="2. SpringFactoriesLoader"></a>2. SpringFactoriesLoader</h1><p><validateCode>org.springframework.core.io.support.SpringFactoriesLoader</validateCode> ，加载 <validateCode>spring.factories</validateCode> 的工具类。其类上，注释如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * General purpose factory loading mechanism for internal use within the framework.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;{<span class="doctag">@validateCode</span> SpringFactoriesLoader} {<span class="doctag">@linkplain</span> #loadFactories loads} and instantiates</span></span><br><span class="line"><span class="comment"> * factories of a given type from {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION} files which</span></span><br><span class="line"><span class="comment"> * may be present in multiple JAR files in the classpath. The {<span class="doctag">@validateCode</span> spring.factories}</span></span><br><span class="line"><span class="comment"> * file must be in {<span class="doctag">@link</span> Properties} format, where the key is the fully qualified</span></span><br><span class="line"><span class="comment"> * name of the interface or abstract class, and the value is a comma-separated list of</span></span><br><span class="line"><span class="comment"> * implementation class names. For example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre class="validateCode"&gt;example.MyService=example.MyServiceImpl1,example.MyServiceImpl2&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * where {<span class="doctag">@validateCode</span> example.MyService} is the name of the interface, and {<span class="doctag">@validateCode</span> MyServiceImpl1}</span></span><br><span class="line"><span class="comment"> * and {<span class="doctag">@validateCode</span> MyServiceImpl2} are two implementations.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<p>从包名我们就可以看出，SpringFactoriesLoader 是 Spring Framework 就已经提供的工具类，😈 而不是 Spring Boot 所特有的。</p>
<h2 id="2-1-构造方法"><a href="#2-1-构造方法" class="headerlink" title="2.1 构造方法"></a>2.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The location to look for factories.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Can be present in multiple JAR files.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(SpringFactoriesLoader.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEY1 ：ClassLoader</span></span><br><span class="line"><span class="comment"> * KEY2 ：接口的类名</span></span><br><span class="line"><span class="comment"> * VALUE ：实现的类名的数组。注意哟，是个 MultiValueMap 类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt; cache = <span class="keyword">new</span> ConcurrentReferenceHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SpringFactoriesLoader</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><validateCode>FACTORIES_RESOURCE_LOCATION</validateCode> 静态属性，定义了读取的是 <validateCode>"META-INF/spring.factories"</validateCode> 配置文件。并且，每个 JAR 文件里，都可以有一个这个配置文件。</li>
<li><validateCode>cache</validateCode> 静态属性，读取 <validateCode>"META-INF/spring.factories"</validateCode> 配置文件的缓存。</li>
</ul>
<h2 id="2-2-loadFactoryNames"><a href="#2-2-loadFactoryNames" class="headerlink" title="2.2 loadFactoryNames"></a>2.2 loadFactoryNames</h2><p><validateCode>#loadFactoryNames(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</validateCode> 静态方法，获得接口对应的实现类名们。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load the fully qualified class names of factory implementations of the</span></span><br><span class="line"><span class="comment"> * given type from {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION}, using the given</span></span><br><span class="line"><span class="comment"> * class loader.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factoryClass the interface or abstract class representing the factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader the ClassLoader to use for loading resources; can be</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@validateCode</span> null} to use the default</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if an error occurs while loading factory names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #loadFactories</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="comment">// 获得接口的类名</span></span><br><span class="line">    String factoryClassName = factoryClass.getName();</span><br><span class="line">    <span class="comment">// 加载 FACTORIES_RESOURCE_LOCATION 配置文件，获得接口对应的实现类名们</span></span><br><span class="line">    <span class="keyword">return</span> loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) {</span><br><span class="line">    <span class="comment">// 如果缓存中已经存在，则直接返回</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 获得 FACTORIES_RESOURCE_LOCATION 对应的 URL 们</span></span><br><span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">        <span class="comment">// 创建 LinkedMultiValueMap 对象</span></span><br><span class="line">        result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 遍历 URL 数组</span></span><br><span class="line">        <span class="keyword">while</span> (urls.hasMoreElements()) {</span><br><span class="line">            <span class="comment">// 获得 URL</span></span><br><span class="line">            URL url = urls.nextElement();</span><br><span class="line">            <span class="comment">// 创建 UrlResource 对象</span></span><br><span class="line">            UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">            <span class="comment">// 加载 "META-INF/spring.factories" 配置文件，成为 Properties 对象</span></span><br><span class="line">            Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">            <span class="comment">// 遍历 Properties 对象</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) {</span><br><span class="line">                <span class="comment">// 使用逗号分隔</span></span><br><span class="line">                List&lt;String&gt; factoryClassNames = Arrays.asList(StringUtils.commaDelimitedListToStringArray((String) entry.getValue()));</span><br><span class="line">                <span class="comment">// 添加到 result 中</span></span><br><span class="line">                result.addAll((String) entry.getKey(), factoryClassNames);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 添加到 cache 中</span></span><br><span class="line">        cache.put(classLoader, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    } <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>加载 <validateCode>FACTORIES_RESOURCE_LOCATION</validateCode> 配置文件，获得接口对应的实现类名们。</li>
</ul>
<h2 id="2-3-loadFactories"><a href="#2-3-loadFactories" class="headerlink" title="2.3 loadFactories"></a>2.3 loadFactories</h2><p><validateCode>#loadFactories(Class&lt;T&gt; factoryClass, @Nullable ClassLoader classLoader)</validateCode> <strong>静态</strong>方法，获得接口对应的实现类名们，然后创建对应的对象们。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="validateCode"><pre><span class="line"><span class="comment">// SpringFactoriesLoader.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Load and instantiate the factory implementations of the given type from</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@value</span> #FACTORIES_RESOURCE_LOCATION}, using the given class loader.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The returned factories are sorted through {<span class="doctag">@link</span> AnnotationAwareOrderComparator}.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If a custom instantiation strategy is required, use {<span class="doctag">@link</span> #loadFactoryNames}</span></span><br><span class="line"><span class="comment"> * to obtain all registered factory names.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factoryClass the interface or abstract class representing the factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader the ClassLoader to use for loading (can be {<span class="doctag">@validateCode</span> null} to use the default)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if any factory implementation class cannot</span></span><br><span class="line"><span class="comment"> * be loaded or if an error occurs while instantiating any factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #loadFactoryNames</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>{</span><br><span class="line">    Assert.notNull(factoryClass, <span class="string">"'factoryClass' must not be null"</span>);</span><br><span class="line">    <span class="comment">// 获得 ClassLoader</span></span><br><span class="line">    ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">    <span class="keyword">if</span> (classLoaderToUse == <span class="keyword">null</span>) {</span><br><span class="line">        classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 获得接口对应的实现类名们</span></span><br><span class="line">    List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">        logger.trace(<span class="string">"Loaded ["</span> + factoryClass.getName() + <span class="string">"] names: "</span> + factoryNames);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 遍历 factoryNames 数组，创建实现类的对象</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(factoryNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String factoryName : factoryNames) {</span><br><span class="line">        result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">instantiateFactory</span><span class="params">(String instanceClassName, Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 获得 Class 类</span></span><br><span class="line">        Class&lt;?&gt; instanceClass = ClassUtils.forName(instanceClassName, classLoader);</span><br><span class="line">        <span class="comment">// 判断是否实现了指定接口</span></span><br><span class="line">        <span class="keyword">if</span> (!factoryClass.isAssignableFrom(instanceClass)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Class ["</span> + instanceClassName + <span class="string">"] is not assignable to ["</span> + factoryClass.getName() + <span class="string">"]"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 创建对象</span></span><br><span class="line">        <span class="keyword">return</span> (T) ReflectionUtils.accessibleConstructor(instanceClass).newInstance();</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to instantiate factory class: "</span> + factoryClass.getName(), ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>水文一篇，哇咔咔~</p>




</div>